<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TranscriptGrab â€” Library</title>
<meta name="description" content="Your saved content library. View, manage, and revisit all your generated content.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/content-cards.css">
<style>
  :root {
    --white: #ffffff; --bg: #fafafa; --surface: #ffffff; --border: #e8e8e8; --border-light: #f0f0f0;
    --text: #111111; --text-2: #333333; --text-3: #666666; --text-4: #999999; --text-5: #bbbbbb;
    --accent: #111111; --accent-hover: #333333; --accent-subtle: #f5f5f5;
    --cta: #0071e3; --cta-hover: #0077ED;
    --success: #34c759; --error: #ff3b30;
    --radius: 16px; --radius-sm: 10px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.04); --shadow-md: 0 4px 16px rgba(0,0,0,0.06); --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
    --transition: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Outfit', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
  ::selection { background: var(--text); color: var(--white); }

  /* ===== LAYOUT ===== */
  .lib-wrap { max-width: 900px; margin: 0 auto; padding: 0 40px 80px; }

  /* ===== AUTH GATE ===== */
  .auth-gate { text-align: center; padding: 120px 24px; }
  .auth-gate h1 { font-size: clamp(24px, 4vw, 32px); font-weight: 900; letter-spacing: -0.04em; margin-bottom: 12px; }
  .auth-gate p { font-size: 15px; color: var(--text-3); margin-bottom: 32px; }
  .auth-gate .signin-btn {
    display: inline-flex; align-items: center; gap: 10px;
    padding: 14px 32px; background: var(--surface); border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600; color: var(--text);
    cursor: pointer; transition: all 0.2s; text-decoration: none;
  }
  .auth-gate .signin-btn:hover { border-color: var(--text-4); box-shadow: var(--shadow-md); transform: translateY(-1px); }
  .auth-gate .signin-btn svg { width: 18px; height: 18px; }

  /* ===== EMPTY STATE ===== */
  .empty-state { text-align: center; padding: 100px 24px; }
  .empty-state h2 { font-size: 24px; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 10px; }
  .empty-state p { font-size: 15px; color: var(--text-3); margin-bottom: 28px; }
  .empty-state .cta-btn {
    display: inline-block; padding: 14px 36px; background: var(--cta); color: var(--white); border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer;
    transition: all 0.2s; text-decoration: none;
  }
  .empty-state .cta-btn:hover { background: var(--cta-hover); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,113,227,0.2); }

  /* ===== HEADER ===== */
  .lib-header { padding-top: 40px; margin-bottom: 28px; display: flex; align-items: center; justify-content: space-between; }
  .lib-header h1 { font-size: 28px; font-weight: 900; letter-spacing: -0.04em; }
  .lib-count { font-size: 13px; color: var(--text-4); font-weight: 500; }

  /* ===== VIDEO LIST ===== */
  .video-list { display: flex; flex-direction: column; gap: 12px; }

  .video-item {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden; transition: all var(--transition);
  }
  .video-item:hover { box-shadow: var(--shadow-md); }

  .video-summary {
    display: flex; align-items: center; gap: 16px; padding: 16px 20px; cursor: pointer;
    transition: background 0.15s;
  }
  .video-summary:hover { background: var(--accent-subtle); }

  .video-thumb {
    width: 120px; height: 68px; border-radius: 8px; object-fit: cover; flex-shrink: 0;
    background: var(--border-light);
  }
  .video-info { flex: 1; min-width: 0; }
  .video-title {
    font-size: 15px; font-weight: 700; letter-spacing: -0.02em; line-height: 1.3;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .video-meta { display: flex; align-items: center; gap: 12px; margin-top: 6px; }
  .video-date { font-size: 12px; color: var(--text-4); font-weight: 500; }
  .platform-badges { display: flex; gap: 4px; }
  .platform-badge {
    display: inline-block; padding: 2px 8px; border-radius: 100px;
    font-size: 10px; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase;
    background: var(--accent-subtle); color: var(--text-4); border: 1px solid var(--border-light);
  }

  .video-actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
  .video-action-btn {
    padding: 6px 14px; border: 1px solid var(--border); border-radius: 100px; background: var(--surface);
    font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 600; color: var(--text-3);
    cursor: pointer; transition: all 0.2s; white-space: nowrap;
  }
  .video-action-btn:hover { border-color: var(--text-4); color: var(--text); }
  .video-action-btn.danger:hover { border-color: var(--error); color: var(--error); }

  /* ===== EXPAND / COLLAPSE ===== */
  .video-content { display: none; border-top: 1px solid var(--border-light); }
  .video-content.open { display: block; animation: slideDown 0.3s ease; }
  .video-content-inner { padding: 20px; }
  .video-content .platform-grid { margin-top: 0; }

  .content-loading {
    text-align: center; padding: 40px 20px;
  }
  .content-loading .spinner {
    width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--cta);
    border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px;
  }
  .content-loading p { font-size: 13px; color: var(--text-4); }

  /* ===== LOADING STATE ===== */
  .lib-loading { text-align: center; padding: 80px 24px; }
  .lib-loading .spinner {
    width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--cta);
    border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px;
  }
  .lib-loading p { font-size: 14px; color: var(--text-4); }

  /* ===== ERROR STATE ===== */
  .lib-error { text-align: center; padding: 80px 24px; }
  .lib-error p { font-size: 14px; color: var(--error); }

  /* ===== CONFIRM DIALOG ===== */
  .confirm-overlay {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(250,250,250,0.97);
    display: flex; align-items: center; justify-content: center; padding: 24px;
  }
  .confirm-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    padding: 36px 32px; max-width: 380px; width: 100%; text-align: center;
    box-shadow: var(--shadow-lg); animation: slideUp 0.2s ease;
  }
  .confirm-card h3 { font-size: 18px; font-weight: 800; margin-bottom: 8px; }
  .confirm-card p { font-size: 14px; color: var(--text-3); margin-bottom: 24px; }
  .confirm-btns { display: flex; gap: 10px; justify-content: center; }
  .confirm-btn {
    padding: 10px 28px; border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .confirm-btn.cancel { background: var(--accent-subtle); color: var(--text-3); border: 1px solid var(--border); }
  .confirm-btn.cancel:hover { background: var(--border); color: var(--text); }
  .confirm-btn.delete { background: var(--error); color: var(--white); }
  .confirm-btn.delete:hover { opacity: 0.9; transform: translateY(-1px); }

  .hidden { display: none !important; }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  @media (max-width: 600px) {
    .lib-wrap { padding: 0 24px 80px; }
    .video-summary { flex-wrap: wrap; gap: 12px; }
    .video-thumb { width: 100%; height: auto; aspect-ratio: 16/9; }
    .video-actions { width: 100%; justify-content: flex-end; }
    .lib-header { flex-direction: column; gap: 8px; align-items: flex-start; }
  }
</style>
</head>
<body>
<script src="/nav.js"></script>
<script src="/pro.js"></script>
<script src="/content-cards.js"></script>

<div class="lib-wrap">
  <!-- Auth gate (shown when not signed in) -->
  <div class="auth-gate hidden" id="auth-gate">
    <h1>Your content library</h1>
    <p>Sign in to save, manage, and revisit all your generated content.</p>
    <a href="/api/auth/google" class="signin-btn">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </a>
  </div>

  <!-- Loading state -->
  <div class="lib-loading hidden" id="lib-loading">
    <div class="spinner"></div>
    <p>Loading your library...</p>
  </div>

  <!-- Error state -->
  <div class="lib-error hidden" id="lib-error">
    <p id="lib-error-text">Something went wrong.</p>
  </div>

  <!-- Empty state -->
  <div class="empty-state hidden" id="empty-state">
    <h2>No content yet</h2>
    <p>Generate your first video to start building your library.</p>
    <a href="/app" class="cta-btn">Generate Content</a>
  </div>

  <!-- Library content -->
  <div class="hidden" id="lib-content">
    <div class="lib-header">
      <h1>Library</h1>
      <span class="lib-count" id="lib-count"></span>
    </div>
    <div class="video-list" id="video-list"></div>
  </div>
</div>

<script>
(function(){
  'use strict';

  var videos = [];
  var expandedId = null;
  var contentCache = {};

  // ==============================
  // INIT
  // ==============================
  TGUser.ready.then(function() {
    if (!TGUser.isSignedIn()) {
      document.getElementById('auth-gate').classList.remove('hidden');
      return;
    }
    loadLibrary();
  });

  // ==============================
  // LOAD LIBRARY
  // ==============================
  async function loadLibrary() {
    document.getElementById('lib-loading').classList.remove('hidden');

    try {
      var res = await fetch('/api/library', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load library');
      var data = await res.json();

      document.getElementById('lib-loading').classList.add('hidden');

      if (!data.videos || data.videos.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
        return;
      }

      videos = data.videos;
      document.getElementById('lib-count').textContent = data.total + ' video' + (data.total !== 1 ? 's' : '');
      renderVideoList();
      document.getElementById('lib-content').classList.remove('hidden');

      // Auto-expand from URL param
      var params = new URLSearchParams(window.location.search);
      var autoExpand = params.get('v');
      if (autoExpand) {
        expandVideo(autoExpand);
      }

    } catch(e) {
      document.getElementById('lib-loading').classList.add('hidden');
      document.getElementById('lib-error-text').textContent = e.message;
      document.getElementById('lib-error').classList.remove('hidden');
    }
  }

  // ==============================
  // RENDER VIDEO LIST
  // ==============================
  function renderVideoList() {
    var list = document.getElementById('video-list');
    list.innerHTML = '';

    videos.forEach(function(v) {
      var item = document.createElement('div');
      item.className = 'video-item';
      item.id = 'vi-' + v.video_id;

      var date = new Date(v.updated_at);
      var dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      var badgesHtml = '';
      if (v.platforms && v.platforms.length) {
        v.platforms.forEach(function(p) {
          badgesHtml += '<span class="platform-badge">' + escapeHtml(p) + '</span>';
        });
      }

      item.innerHTML =
        '<div class="video-summary" onclick="toggleVideo(\'' + v.video_id + '\')">' +
          '<img class="video-thumb" src="' + escapeAttr(v.video_thumb || 'https://img.youtube.com/vi/' + v.video_id + '/mqdefault.jpg') + '" alt="" loading="lazy">' +
          '<div class="video-info">' +
            '<div class="video-title">' + escapeHtml(v.video_title || v.video_id) + '</div>' +
            '<div class="video-meta">' +
              '<span class="video-date">' + dateStr + '</span>' +
              '<div class="platform-badges">' + badgesHtml + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="video-actions">' +
            '<a href="/app?v=' + v.video_id + '" class="video-action-btn" onclick="event.stopPropagation()">Regenerate</a>' +
            '<button class="video-action-btn danger" onclick="event.stopPropagation();confirmDelete(\'' + v.video_id + '\',\'' + escapeAttr(v.video_title || v.video_id) + '\')">Delete</button>' +
          '</div>' +
        '</div>' +
        '<div class="video-content" id="vc-' + v.video_id + '"></div>';

      list.appendChild(item);
    });
  }

  // ==============================
  // EXPAND / COLLAPSE
  // ==============================
  window.toggleVideo = function(videoId) {
    var contentEl = document.getElementById('vc-' + videoId);
    if (!contentEl) return;

    if (contentEl.classList.contains('open')) {
      contentEl.classList.remove('open');
      expandedId = null;
      return;
    }

    // Collapse any other open
    if (expandedId) {
      var prev = document.getElementById('vc-' + expandedId);
      if (prev) prev.classList.remove('open');
    }

    expandedId = videoId;
    expandVideo(videoId);
  };

  async function expandVideo(videoId) {
    var contentEl = document.getElementById('vc-' + videoId);
    if (!contentEl) return;

    contentEl.classList.add('open');
    expandedId = videoId;

    // Scroll into view
    var item = document.getElementById('vi-' + videoId);
    if (item) {
      setTimeout(function() {
        item.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    // Check cache
    if (contentCache[videoId]) {
      renderVideoContent(videoId, contentCache[videoId]);
      return;
    }

    // Show loading
    contentEl.innerHTML =
      '<div class="content-loading">' +
        '<div class="spinner"></div>' +
        '<p>Loading content...</p>' +
      '</div>';

    try {
      var res = await fetch('/api/library?v=' + videoId, { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load content');
      var data = await res.json();

      contentCache[videoId] = data.content;
      renderVideoContent(videoId, data.content);

    } catch(e) {
      contentEl.innerHTML =
        '<div class="content-loading">' +
          '<p style="color:var(--error)">' + escapeHtml(e.message) + '</p>' +
        '</div>';
    }
  }

  function renderVideoContent(videoId, content) {
    var contentEl = document.getElementById('vc-' + videoId);
    if (!contentEl) return;

    var inner = document.createElement('div');
    inner.className = 'video-content-inner';
    var grid = document.createElement('div');
    grid.className = 'platform-grid';
    TGCards.renderCards(content, grid);
    inner.appendChild(grid);

    contentEl.innerHTML = '';
    contentEl.appendChild(inner);
  }

  // ==============================
  // DELETE
  // ==============================
  window.confirmDelete = function(videoId, title) {
    var overlay = document.createElement('div');
    overlay.className = 'confirm-overlay';
    overlay.id = 'confirm-overlay';
    overlay.innerHTML =
      '<div class="confirm-card">' +
        '<h3>Delete this video?</h3>' +
        '<p>All generated content for \u201C' + escapeHtml(title) + '\u201D will be permanently removed.</p>' +
        '<div class="confirm-btns">' +
          '<button class="confirm-btn cancel" onclick="document.getElementById(\'confirm-overlay\').remove()">Cancel</button>' +
          '<button class="confirm-btn delete" id="confirm-delete-btn">Delete</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(overlay);

    document.getElementById('confirm-delete-btn').onclick = async function() {
      this.textContent = 'Deleting...';
      this.disabled = true;

      try {
        var res = await fetch('/api/library?v=' + videoId, {
          method: 'DELETE',
          credentials: 'same-origin'
        });
        if (!res.ok) throw new Error('Delete failed');

        overlay.remove();
        delete contentCache[videoId];

        // Remove from list
        videos = videos.filter(function(v) { return v.video_id !== videoId; });
        if (expandedId === videoId) expandedId = null;

        if (videos.length === 0) {
          document.getElementById('lib-content').classList.add('hidden');
          document.getElementById('empty-state').classList.remove('hidden');
        } else {
          document.getElementById('lib-count').textContent = videos.length + ' video' + (videos.length !== 1 ? 's' : '');
          var itemEl = document.getElementById('vi-' + videoId);
          if (itemEl) {
            itemEl.style.transition = 'opacity 0.3s, transform 0.3s';
            itemEl.style.opacity = '0';
            itemEl.style.transform = 'translateX(-20px)';
            setTimeout(function() { itemEl.remove(); }, 300);
          }
        }
      } catch(e) {
        overlay.remove();
      }
    };
  };

  // ==============================
  // UTILS
  // ==============================
  function escapeHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }
  function escapeAttr(s) {
    return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

})();
</script>
<script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
