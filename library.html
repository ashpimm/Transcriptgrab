<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TranscriptGrab â€” Your Generated Content Library</title>
<meta name="description" content="View and manage content generated from your video transcripts. Revisit tweets, LinkedIn posts, blog articles, and more.">
<meta name="robots" content="noindex">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>T</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/content-cards.css">
<style>
  :root {
    --white: #ffffff; --bg: #f8f9fb; --surface: #ffffff; --border: #e5e7ec; --border-light: #eef0f4;
    --text: #0f1115; --text-2: #2d3039; --text-3: #5c5f6a; --text-4: #8f929d; --text-5: #b5b8c2;
    --accent: #0f1115; --accent-hover: #2d3039; --accent-subtle: #f3f4f7;
    --cta: #0071e3; --cta-hover: #0077ED;
    --success: #34c759; --error: #ff3b30;
    --radius: 16px; --radius-sm: 10px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.03), 0 1px 2px rgba(0,0,0,0.02);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.03);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.07), 0 2px 8px rgba(0,0,0,0.03);
    --transition: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Outfit', -apple-system, sans-serif;
    background: var(--bg);
    background-image:
      radial-gradient(ellipse 80% 50% at 50% -20%, rgba(0,113,227,0.04) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 100% 100%, rgba(120,90,220,0.03) 0%, transparent 50%);
    color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }
  ::selection { background: var(--cta); color: var(--white); }

  /* ===== LAYOUT ===== */
  .lib-wrap { max-width: 900px; margin: 0 auto; padding: 0 40px 80px; }

  /* ===== AUTH GATE ===== */
  .auth-gate { text-align: center; padding: 120px 24px; }
  .auth-gate h1 { font-size: clamp(24px, 4vw, 32px); font-weight: 900; letter-spacing: -0.04em; margin-bottom: 12px; }
  .auth-gate p { font-size: 15px; color: var(--text-3); margin-bottom: 32px; }
  .auth-gate .signin-btn {
    display: inline-flex; align-items: center; gap: 10px;
    padding: 14px 32px; background: var(--surface); border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600; color: var(--text);
    cursor: pointer; transition: all 0.2s; text-decoration: none;
  }
  .auth-gate .signin-btn:hover { border-color: var(--text-4); box-shadow: var(--shadow-md); transform: translateY(-1px); }
  .auth-gate .signin-btn svg { width: 18px; height: 18px; }

  /* ===== EMPTY STATE ===== */
  .empty-state { text-align: center; padding: 100px 24px; }
  .empty-state h2 { font-size: 24px; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 10px; }
  .empty-state p { font-size: 15px; color: var(--text-3); margin-bottom: 28px; }
  .empty-state .cta-btn {
    display: inline-block; padding: 14px 36px; background: var(--cta); color: var(--white); border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer;
    transition: all 0.2s; text-decoration: none;
  }
  .empty-state .cta-btn:hover { background: var(--cta-hover); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,113,227,0.2); }

  /* ===== HEADER ===== */
  .lib-header { padding-top: 40px; margin-bottom: 28px; display: flex; align-items: center; justify-content: space-between; }
  .lib-header h1 { font-size: 28px; font-weight: 900; letter-spacing: -0.04em; }
  .lib-count { font-size: 13px; color: var(--text-4); font-weight: 500; }

  /* ===== VIDEO LIST ===== */
  .video-list { display: flex; flex-direction: column; gap: 12px; }

  .video-item {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .video-item:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.06), 0 2px 8px rgba(0,0,0,0.03); transform: translateY(-1px); }

  .video-summary {
    display: flex; align-items: center; gap: 16px; padding: 16px 20px; cursor: pointer;
    transition: background 0.15s;
  }
  .video-summary:hover { background: var(--accent-subtle); }

  .video-thumb {
    width: 120px; height: 68px; border-radius: 8px; object-fit: cover; flex-shrink: 0;
    background: var(--border-light); transition: transform 0.3s ease;
  }
  .video-summary:hover .video-thumb { transform: scale(1.03); }
  .video-info { flex: 1; min-width: 0; }
  .video-title {
    font-size: 15px; font-weight: 700; letter-spacing: -0.02em; line-height: 1.3;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .video-meta { display: flex; align-items: center; gap: 12px; margin-top: 6px; }
  .video-date { font-size: 12px; color: var(--text-4); font-weight: 500; }
  .platform-badges { display: flex; gap: 4px; }
  .platform-badge {
    display: inline-block; padding: 2px 8px; border-radius: 100px;
    font-size: 10px; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase;
    background: var(--accent-subtle); color: var(--text-4); border: 1px solid var(--border-light);
  }

  .video-actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
  .video-action-btn {
    padding: 6px 14px; border: 1px solid var(--border); border-radius: 100px; background: var(--surface);
    font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 600; color: var(--text-3);
    cursor: pointer; transition: all 0.2s; white-space: nowrap;
  }
  .video-action-btn:hover { border-color: var(--text-4); color: var(--text); }
  .video-action-btn.danger:hover { border-color: var(--error); color: var(--error); }

  /* ===== EXPAND / COLLAPSE ===== */
  .video-content { display: none; border-top: 1px solid var(--border-light); }
  .video-content.open { display: block; animation: slideDown 0.3s ease; }
  .video-content-inner { padding: 20px; }
  .video-content .platform-grid { margin-top: 0; }

  .content-loading {
    text-align: center; padding: 40px 20px;
  }
  .content-loading .spinner {
    width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--cta);
    border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px;
  }
  .content-loading p { font-size: 13px; color: var(--text-4); }

  /* ===== LOADING STATE ===== */
  .lib-loading { text-align: center; padding: 80px 24px; }
  .lib-loading .spinner {
    width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--cta);
    border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px;
  }
  .lib-loading p { font-size: 14px; color: var(--text-4); }

  /* ===== ERROR STATE ===== */
  .lib-error { text-align: center; padding: 80px 24px; }
  .lib-error p { font-size: 14px; color: var(--error); }

  /* ===== CONFIRM DIALOG ===== */
  .confirm-overlay {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(15,17,21,0.3); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center; padding: 24px;
    animation: fadeIn 0.2s ease;
  }
  .confirm-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    padding: 36px 32px; max-width: 380px; width: 100%; text-align: center;
    box-shadow: 0 24px 80px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.06); animation: slideUp 0.2s ease;
  }
  .confirm-card h3 { font-size: 18px; font-weight: 800; margin-bottom: 8px; }
  .confirm-card p { font-size: 14px; color: var(--text-3); margin-bottom: 24px; }
  .confirm-btns { display: flex; gap: 10px; justify-content: center; }
  .confirm-btn {
    padding: 10px 28px; border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .confirm-btn.cancel { background: var(--accent-subtle); color: var(--text-3); border: 1px solid var(--border); }
  .confirm-btn.cancel:hover { background: var(--border); color: var(--text); }
  .confirm-btn.delete { background: var(--error); color: var(--white); }
  .confirm-btn.delete:hover { opacity: 0.9; transform: translateY(-1px); }

  /* ===== CHANNEL CARD ===== */
  .channel-section { margin-bottom: 24px; padding-top: 40px; }
  .channel-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 24px; transition: all var(--transition);
  }
  .channel-card:hover { box-shadow: var(--shadow-sm); }

  /* Unlinked state */
  .channel-card.unlinked-bg {
    background: linear-gradient(135deg, rgba(0,113,227,0.03) 0%, rgba(120,90,220,0.02) 100%);
    border-color: rgba(0,113,227,0.1);
  }
  .channel-unlinked { text-align: center; padding: 32px 24px; }
  .channel-unlinked h3 { font-size: 16px; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 6px; }
  .channel-unlinked p { font-size: 13px; color: var(--text-3); margin-bottom: 20px; }
  .channel-link-btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 24px; background: var(--cta); color: var(--white); border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .channel-link-btn:hover { background: var(--cta-hover); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,113,227,0.2); }

  /* Linked state */
  .channel-linked { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
  .channel-status-dot {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  }
  .channel-status-dot.active { background: var(--success); box-shadow: 0 0 0 3px rgba(52,199,89,0.2); animation: dotPulse 2s ease-in-out infinite; }
  .channel-status-dot.paused { background: var(--text-5); }
  @keyframes dotPulse { 0%, 100% { box-shadow: 0 0 0 3px rgba(52,199,89,0.2); } 50% { box-shadow: 0 0 0 5px rgba(52,199,89,0.1); } }
  .channel-details { flex: 1; min-width: 0; }
  .channel-name { font-size: 15px; font-weight: 700; letter-spacing: -0.02em; }
  .channel-url-text { font-size: 12px; color: var(--text-4); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
  .channel-formats { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
  .channel-format-badge {
    display: inline-block; padding: 2px 8px; border-radius: 100px;
    font-size: 10px; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase;
    background: rgba(0,113,227,0.08); color: var(--cta); border: 1px solid rgba(0,113,227,0.15);
  }
  .channel-actions { display: flex; gap: 6px; flex-shrink: 0; flex-wrap: wrap; }
  .channel-action-btn {
    padding: 6px 14px; border: 1px solid var(--border); border-radius: 100px; background: var(--surface);
    font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 600; color: var(--text-3);
    cursor: pointer; transition: all 0.2s; white-space: nowrap;
  }
  .channel-action-btn:hover { border-color: var(--text-4); color: var(--text); }
  .channel-action-btn.danger:hover { border-color: var(--error); color: var(--error); }

  /* Channel modal */
  .channel-modal-overlay {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(15,17,21,0.3); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center; padding: 24px;
    animation: fadeIn 0.2s ease;
  }
  .channel-modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    padding: 36px 32px; max-width: 480px; width: 100%; text-align: center;
    box-shadow: 0 24px 80px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.06); animation: slideUp 0.2s ease;
  }
  .channel-modal h3 { font-size: 20px; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 4px; }
  .channel-modal p { font-size: 13px; color: var(--text-3); margin-bottom: 24px; }
  .channel-modal-input {
    width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm);
    font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: var(--text);
    background: var(--bg); outline: none; transition: border-color 0.2s;
  }
  .channel-modal-input:focus { border-color: var(--cta); }
  .channel-modal-input::placeholder { color: var(--text-5); }
  .channel-modal-label { font-size: 13px; font-weight: 600; color: var(--text-2); margin: 20px 0 10px; display: block; text-align: left; }
  .channel-modal .format-picker { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
  .channel-modal .format-pill {
    padding: 8px 18px; border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 500; color: var(--text-3);
    background: var(--surface); cursor: pointer; transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .channel-modal .format-pill:hover { border-color: var(--text-4); color: var(--text-2); }
  .channel-modal .format-pill.selected { background: var(--text); color: var(--white); border-color: var(--text); }
  .channel-modal .format-pill .pill-icon { font-size: 14px; }
  .channel-modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 24px; }
  .channel-modal-btn {
    padding: 12px 28px; border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .channel-modal-btn.cancel { background: var(--accent-subtle); color: var(--text-3); border: 1px solid var(--border); }
  .channel-modal-btn.cancel:hover { background: var(--border); color: var(--text); }
  .channel-modal-btn.submit { background: var(--cta); color: var(--white); }
  .channel-modal-btn.submit:hover { background: var(--cta-hover); transform: translateY(-1px); }
  .channel-modal-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .channel-modal-error { font-size: 12px; color: var(--error); margin-top: 12px; }

  /* Auto badge */
  .auto-badge {
    display: inline-block; padding: 2px 6px; border-radius: 100px;
    font-size: 9px; font-weight: 800; letter-spacing: 0.06em; text-transform: uppercase;
    background: rgba(0,113,227,0.08); color: var(--cta); border: 1px solid rgba(0,113,227,0.15);
  }
  .source-badge {
    display: inline-block; padding: 2px 6px; border-radius: 100px;
    font-size: 9px; font-weight: 800; letter-spacing: 0.06em; text-transform: uppercase;
    background: var(--accent-subtle); color: var(--text-4); border: 1px solid var(--border-light);
  }

  .hidden { display: none !important; }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  @media (max-width: 600px) {
    .lib-wrap { padding: 0 24px 80px; }
    .video-summary { flex-wrap: wrap; gap: 12px; }
    .video-thumb { width: 100%; height: auto; aspect-ratio: 16/9; }
    .video-actions { width: 100%; justify-content: flex-end; }
    .lib-header { flex-direction: column; gap: 8px; align-items: flex-start; }
  }
</style>
</head>
<body>
<script src="/nav.js"></script>
<script src="/pro.js"></script>
<script src="/content-cards.js"></script>

<div class="lib-wrap">
  <!-- Auth gate (shown when not signed in) -->
  <div class="auth-gate hidden" id="auth-gate">
    <h1>Your content library</h1>
    <p>Sign in to save, manage, and revisit all your generated content.</p>
    <a href="/api/auth/google" class="signin-btn">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </a>
  </div>

  <!-- Loading state -->
  <div class="lib-loading hidden" id="lib-loading">
    <div class="spinner"></div>
    <p>Loading your library...</p>
  </div>

  <!-- Error state -->
  <div class="lib-error hidden" id="lib-error">
    <p id="lib-error-text">Something went wrong.</p>
  </div>

  <!-- Empty state -->
  <div class="empty-state hidden" id="empty-state">
    <h2>No content yet</h2>
    <p>Generate your first video to start building your library.</p>
    <a href="/app" class="cta-btn">Generate Content</a>
  </div>

  <!-- Channel section (Pro only) -->
  <div class="channel-section hidden" id="channel-section">
    <!-- Unlinked state -->
    <div class="channel-card unlinked-bg hidden" id="channel-unlinked">
      <div class="channel-unlinked">
        <h3>Auto-generate from your channel</h3>
        <p>Link your YouTube channel and new uploads get content generated automatically.</p>
        <button class="channel-link-btn" onclick="openChannelModal()">Link Channel</button>
      </div>
    </div>
    <!-- Linked state -->
    <div class="channel-card hidden" id="channel-linked">
      <div class="channel-linked">
        <span class="channel-status-dot" id="channel-dot"></span>
        <div class="channel-details">
          <div class="channel-name" id="channel-name"></div>
          <div class="channel-url-text" id="channel-url-text"></div>
          <div class="channel-formats" id="channel-formats"></div>
        </div>
        <div class="channel-actions">
          <button class="channel-action-btn" onclick="openEditFormats()">Edit Formats</button>
          <button class="channel-action-btn" id="channel-pause-btn" onclick="toggleChannelPause()"></button>
          <button class="channel-action-btn danger" onclick="confirmUnlink()">Unlink</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Library content -->
  <div class="hidden" id="lib-content">
    <div class="lib-header">
      <h1>Library</h1>
      <span class="lib-count" id="lib-count"></span>
    </div>
    <div class="video-list" id="video-list"></div>
  </div>
</div>

<script>
(function(){
  'use strict';

  var videos = [];
  var expandedId = null;
  var contentCache = {};
  var channelData = null;

  // ==============================
  // INIT
  // ==============================
  TGUser.ready.then(function() {
    if (!TGUser.isSignedIn()) {
      document.getElementById('auth-gate').classList.remove('hidden');
      return;
    }
    loadLibrary();
    if (TGUser.isPro()) {
      loadChannel();
    }
  });

  // ==============================
  // LOAD LIBRARY
  // ==============================
  async function loadLibrary() {
    document.getElementById('lib-loading').classList.remove('hidden');

    try {
      var res = await fetch('/api/library', { credentials: 'same-origin' });
      if (res.status === 401) {
        document.getElementById('lib-loading').classList.add('hidden');
        document.getElementById('auth-gate').classList.remove('hidden');
        return;
      }
      if (!res.ok) throw new Error('Failed to load library');
      var data = await res.json();

      document.getElementById('lib-loading').classList.add('hidden');

      if (!data.videos || data.videos.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
        return;
      }

      videos = data.videos;
      document.getElementById('lib-count').textContent = data.total + ' video' + (data.total !== 1 ? 's' : '');
      renderVideoList();
      document.getElementById('lib-content').classList.remove('hidden');

      // Auto-expand from URL param
      var params = new URLSearchParams(window.location.search);
      var autoExpandId = params.get('id');
      if (autoExpandId) {
        expandVideo(parseInt(autoExpandId, 10));
      } else {
        // Legacy: ?v= looks up by video_id
        var autoExpandV = params.get('v');
        if (autoExpandV) {
          var match = videos.find(function(v) { return v.video_id === autoExpandV; });
          if (match) expandVideo(match.id);
        }
      }

    } catch(e) {
      document.getElementById('lib-loading').classList.add('hidden');
      document.getElementById('lib-error-text').textContent = e.message;
      document.getElementById('lib-error').classList.remove('hidden');
    }
  }

  // ==============================
  // RENDER VIDEO LIST
  // ==============================
  function renderVideoList() {
    var list = document.getElementById('video-list');
    list.innerHTML = '';

    videos.forEach(function(v) {
      var item = document.createElement('div');
      item.className = 'video-item';
      item.id = 'vi-' + v.id;

      var date = new Date(v.updated_at);
      var dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      var plat = v.platform || 'youtube';

      // Thumbnail: use stored thumb, fallback to YouTube thumb only for YouTube
      var thumbSrc = v.video_thumb;
      if (!thumbSrc && plat === 'youtube' && v.video_id && /^[a-zA-Z0-9_-]{11}$/.test(v.video_id)) {
        thumbSrc = 'https://img.youtube.com/vi/' + v.video_id + '/mqdefault.jpg';
      }
      if (!thumbSrc) thumbSrc = '';

      // Regenerate link: YouTube uses ?v=, others use ?url=
      var regenHref;
      if (plat === 'youtube' && v.video_id && /^[a-zA-Z0-9_-]{11}$/.test(v.video_id)) {
        regenHref = '/app?v=' + v.video_id;
      } else {
        regenHref = '/app?url=' + encodeURIComponent(v.video_id);
      }

      var badgesHtml = '';
      if (v.auto_generated) {
        badgesHtml += '<span class="auto-badge">AUTO</span>';
      }
      if (plat !== 'youtube') {
        badgesHtml += '<span class="source-badge">' + escapeHtml(plat) + '</span>';
      }
      if (v.platforms && v.platforms.length) {
        v.platforms.forEach(function(p) {
          badgesHtml += '<span class="platform-badge">' + escapeHtml(p) + '</span>';
        });
      }

      var thumbHtml = thumbSrc
        ? '<img class="video-thumb" src="' + escapeAttr(thumbSrc) + '" alt="" loading="lazy">'
        : '<div class="video-thumb" style="display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--text-4);background:var(--accent-subtle);">' + platformIcon(plat) + '</div>';

      item.innerHTML =
        '<div class="video-summary" onclick="toggleVideo(' + v.id + ')">' +
          thumbHtml +
          '<div class="video-info">' +
            '<div class="video-title">' + escapeHtml(v.video_title || 'Video') + '</div>' +
            '<div class="video-meta">' +
              '<span class="video-date">' + dateStr + '</span>' +
              '<div class="platform-badges">' + badgesHtml + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="video-actions">' +
            '<a href="' + escapeAttr(regenHref) + '" class="video-action-btn" onclick="event.stopPropagation()">Regenerate</a>' +
            '<button class="video-action-btn danger" onclick="event.stopPropagation();confirmDelete(' + v.id + ',\'' + escapeAttr(v.video_title || 'Video') + '\')">Delete</button>' +
          '</div>' +
        '</div>' +
        '<div class="video-content" id="vc-' + v.id + '"></div>';

      list.appendChild(item);
    });
  }

  function platformIcon(plat) {
    var icons = { youtube: '&#9654;', tiktok: '&#9835;', instagram: '&#128247;', facebook: 'f', twitter: '&#120143;' };
    return icons[plat] || '&#9654;';
  }

  // ==============================
  // EXPAND / COLLAPSE
  // ==============================
  window.toggleVideo = function(genId) {
    var contentEl = document.getElementById('vc-' + genId);
    if (!contentEl) return;

    if (contentEl.classList.contains('open')) {
      contentEl.classList.remove('open');
      expandedId = null;
      return;
    }

    // Collapse any other open
    if (expandedId) {
      var prev = document.getElementById('vc-' + expandedId);
      if (prev) prev.classList.remove('open');
    }

    expandedId = genId;
    expandVideo(genId);
  };

  async function expandVideo(genId) {
    var contentEl = document.getElementById('vc-' + genId);
    if (!contentEl) return;

    contentEl.classList.add('open');
    expandedId = genId;

    // Scroll into view
    var item = document.getElementById('vi-' + genId);
    if (item) {
      setTimeout(function() {
        item.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    // Check cache
    if (contentCache[genId]) {
      renderVideoContent(genId, contentCache[genId]);
      return;
    }

    // Show loading
    contentEl.innerHTML =
      '<div class="content-loading">' +
        '<div class="spinner"></div>' +
        '<p>Loading content...</p>' +
      '</div>';

    try {
      var res = await fetch('/api/library?id=' + genId, { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load content');
      var data = await res.json();

      contentCache[genId] = data.content;
      renderVideoContent(genId, data.content);

    } catch(e) {
      contentEl.innerHTML =
        '<div class="content-loading">' +
          '<p style="color:var(--error)">' + escapeHtml(e.message) + '</p>' +
        '</div>';
    }
  }

  function renderVideoContent(genId, content) {
    var contentEl = document.getElementById('vc-' + genId);
    if (!contentEl) return;

    var inner = document.createElement('div');
    inner.className = 'video-content-inner';
    var grid = document.createElement('div');
    grid.className = 'platform-grid';
    TGCards.renderCards(content, grid);
    inner.appendChild(grid);

    contentEl.innerHTML = '';
    contentEl.appendChild(inner);
  }

  // ==============================
  // DELETE
  // ==============================
  window.confirmDelete = function(genId, title) {
    var overlay = document.createElement('div');
    overlay.className = 'confirm-overlay';
    overlay.id = 'confirm-overlay';
    overlay.innerHTML =
      '<div class="confirm-card">' +
        '<h3>Delete this video?</h3>' +
        '<p>All generated content for \u201C' + escapeHtml(title) + '\u201D will be permanently removed.</p>' +
        '<div class="confirm-btns">' +
          '<button class="confirm-btn cancel" onclick="document.getElementById(\'confirm-overlay\').remove()">Cancel</button>' +
          '<button class="confirm-btn delete" id="confirm-delete-btn">Delete</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(overlay);

    document.getElementById('confirm-delete-btn').onclick = async function() {
      this.textContent = 'Deleting...';
      this.disabled = true;

      try {
        var res = await fetch('/api/library?id=' + genId, {
          method: 'DELETE',
          credentials: 'same-origin'
        });
        if (!res.ok) throw new Error('Delete failed');

        overlay.remove();
        delete contentCache[genId];

        // Remove from list
        videos = videos.filter(function(v) { return v.id !== genId; });
        if (expandedId === genId) expandedId = null;

        if (videos.length === 0) {
          document.getElementById('lib-content').classList.add('hidden');
          document.getElementById('empty-state').classList.remove('hidden');
        } else {
          document.getElementById('lib-count').textContent = videos.length + ' video' + (videos.length !== 1 ? 's' : '');
          var itemEl = document.getElementById('vi-' + genId);
          if (itemEl) {
            itemEl.style.transition = 'opacity 0.3s, transform 0.3s';
            itemEl.style.opacity = '0';
            itemEl.style.transform = 'translateX(-20px)';
            setTimeout(function() { itemEl.remove(); }, 300);
          }
        }
      } catch(e) {
        overlay.remove();
      }
    };
  };

  // ==============================
  // UTILS
  // ==============================
  function escapeHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }
  function escapeAttr(s) {
    return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // ==============================
  // CHANNEL MANAGEMENT
  // ==============================
  async function loadChannel() {
    try {
      var res = await fetch('/api/channel', { credentials: 'same-origin' });
      if (!res.ok) return;
      var data = await res.json();
      channelData = data.channel;
      renderChannel();
    } catch(e) {
      // Non-fatal
    }
  }

  function renderChannel() {
    var section = document.getElementById('channel-section');
    var unlinked = document.getElementById('channel-unlinked');
    var linked = document.getElementById('channel-linked');

    section.classList.remove('hidden');

    if (!channelData) {
      unlinked.classList.remove('hidden');
      linked.classList.add('hidden');
      return;
    }

    unlinked.classList.add('hidden');
    linked.classList.remove('hidden');

    var dot = document.getElementById('channel-dot');
    dot.className = 'channel-status-dot ' + (channelData.enabled ? 'active' : 'paused');

    document.getElementById('channel-name').textContent = channelData.channel_name || 'Linked Channel';
    document.getElementById('channel-url-text').textContent = channelData.channel_url;

    var formatsEl = document.getElementById('channel-formats');
    formatsEl.innerHTML = '';
    if (channelData.default_formats) {
      channelData.default_formats.forEach(function(f) {
        formatsEl.innerHTML += '<span class="channel-format-badge">' + escapeHtml(f) + '</span>';
      });
    }

    var pauseBtn = document.getElementById('channel-pause-btn');
    pauseBtn.textContent = channelData.enabled ? 'Pause' : 'Resume';
  }

  // ===== LINK CHANNEL MODAL =====
  var FORMAT_PILLS = [
    { id: 'twitter', icon: '&#120143;', label: 'Twitter' },
    { id: 'linkedin', icon: 'in', label: 'LinkedIn' },
    { id: 'facebook', icon: 'f', label: 'Facebook' },
    { id: 'instagram', icon: '&#128247;', label: 'Instagram' },
    { id: 'tiktok', icon: '&#9835;', label: 'TikTok' },
    { id: 'blog', icon: '&#9997;&#65039;', label: 'Blog' },
    { id: 'quotes', icon: '&#128172;', label: 'Quotes' },
  ];

  window.openChannelModal = function(editMode) {
    var overlay = document.createElement('div');
    overlay.className = 'channel-modal-overlay';
    overlay.id = 'channel-modal-overlay';

    var title = editMode ? 'Edit Formats' : 'Link Channel';
    var desc = editMode ? 'Choose which formats to auto-generate.' : 'Paste your YouTube channel URL and choose default formats.';

    var urlInput = editMode ? '' :
      '<input class="channel-modal-input" id="channel-url-input" type="text" placeholder="https://youtube.com/@yourchannel">' +
      '<label class="channel-modal-label">Default formats</label>';

    var pillsHtml = '';
    var defaults = editMode && channelData ? channelData.default_formats : ['twitter', 'linkedin'];
    FORMAT_PILLS.forEach(function(f) {
      var sel = defaults.indexOf(f.id) !== -1 ? ' selected' : '';
      pillsHtml += '<button class="format-pill' + sel + '" data-format="' + f.id + '"><span class="pill-icon">' + f.icon + '</span> ' + f.label + '</button>';
    });

    overlay.innerHTML =
      '<div class="channel-modal">' +
        '<h3>' + title + '</h3>' +
        '<p>' + desc + '</p>' +
        urlInput +
        '<div class="format-picker" id="channel-format-picker">' + pillsHtml + '</div>' +
        '<div class="channel-modal-error hidden" id="channel-modal-error"></div>' +
        '<div class="channel-modal-btns">' +
          '<button class="channel-modal-btn cancel" onclick="document.getElementById(\'channel-modal-overlay\').remove()">Cancel</button>' +
          '<button class="channel-modal-btn submit" id="channel-submit-btn">' + (editMode ? 'Save' : 'Link Channel') + '</button>' +
        '</div>' +
      '</div>';

    document.body.appendChild(overlay);

    // Pill click handlers
    document.getElementById('channel-format-picker').addEventListener('click', function(e) {
      var pill = e.target.closest('.format-pill');
      if (!pill) return;
      pill.classList.toggle('selected');
    });

    // Submit handler
    document.getElementById('channel-submit-btn').onclick = async function() {
      var btn = this;
      var errorEl = document.getElementById('channel-modal-error');
      errorEl.classList.add('hidden');

      var selectedPills = document.querySelectorAll('#channel-format-picker .format-pill.selected');
      var formats = [];
      selectedPills.forEach(function(p) { formats.push(p.getAttribute('data-format')); });

      if (formats.length === 0) {
        errorEl.textContent = 'Select at least one format.';
        errorEl.classList.remove('hidden');
        return;
      }

      if (editMode) {
        btn.textContent = 'Saving...';
        btn.disabled = true;
        try {
          var res = await fetch('/api/channel', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ formats: formats }),
          });
          if (!res.ok) { var d = await res.json(); throw new Error(d.error || 'Update failed'); }
          var data = await res.json();
          channelData = data.channel;
          renderChannel();
          overlay.remove();
        } catch(e) {
          errorEl.textContent = e.message;
          errorEl.classList.remove('hidden');
          btn.textContent = 'Save';
          btn.disabled = false;
        }
        return;
      }

      // Link mode
      var urlInput = document.getElementById('channel-url-input');
      var url = urlInput.value.trim();
      if (!url) {
        errorEl.textContent = 'Enter a YouTube channel URL.';
        errorEl.classList.remove('hidden');
        return;
      }

      btn.textContent = 'Linking...';
      btn.disabled = true;

      try {
        var res = await fetch('/api/channel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ url: url, formats: formats }),
        });
        if (!res.ok) { var d = await res.json(); throw new Error(d.error || 'Link failed'); }
        var data = await res.json();
        channelData = data.channel;
        renderChannel();
        overlay.remove();
      } catch(e) {
        errorEl.textContent = e.message;
        errorEl.classList.remove('hidden');
        btn.textContent = 'Link Channel';
        btn.disabled = false;
      }
    };
  };

  window.openEditFormats = function() {
    openChannelModal(true);
  };

  window.toggleChannelPause = async function() {
    if (!channelData) return;
    var newState = !channelData.enabled;
    try {
      var res = await fetch('/api/channel', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ enabled: newState }),
      });
      if (!res.ok) return;
      var data = await res.json();
      channelData = data.channel;
      renderChannel();
    } catch(e) {
      // Non-fatal
    }
  };

  window.confirmUnlink = function() {
    var overlay = document.createElement('div');
    overlay.className = 'confirm-overlay';
    overlay.id = 'confirm-overlay';
    overlay.innerHTML =
      '<div class="confirm-card">' +
        '<h3>Unlink channel?</h3>' +
        '<p>Auto-generation will stop. Your existing generated content stays in the library.</p>' +
        '<div class="confirm-btns">' +
          '<button class="confirm-btn cancel" onclick="document.getElementById(\'confirm-overlay\').remove()">Cancel</button>' +
          '<button class="confirm-btn delete" id="confirm-unlink-btn">Unlink</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(overlay);

    document.getElementById('confirm-unlink-btn').onclick = async function() {
      this.textContent = 'Unlinking...';
      this.disabled = true;
      try {
        var res = await fetch('/api/channel', {
          method: 'DELETE',
          credentials: 'same-origin',
        });
        if (!res.ok) throw new Error('Unlink failed');
        overlay.remove();
        channelData = null;
        renderChannel();
      } catch(e) {
        overlay.remove();
      }
    };
  };

})();
</script>
<script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
