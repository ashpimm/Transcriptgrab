<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard â€” TranscriptGrab Pro</title>
<meta name="description" content="Connect your social accounts and schedule posts directly from TranscriptGrab.">
<meta name="robots" content="noindex">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>T</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --white: #ffffff; --bg: #f8f9fb; --surface: #ffffff; --border: #e5e7ec; --border-light: #eef0f4;
    --text: #0f1115; --text-2: #2d3039; --text-3: #5c5f6a; --text-4: #8f929d; --text-5: #b5b8c2;
    --accent: #0f1115; --accent-hover: #2d3039; --accent-subtle: #f3f4f7;
    --cta: #0071e3; --cta-hover: #0077ED;
    --success: #34c759; --error: #ff3b30;
    --radius: 16px; --radius-sm: 10px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.03), 0 1px 2px rgba(0,0,0,0.02);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.03);
    --transition: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Outfit', -apple-system, sans-serif;
    background: var(--bg);
    background-image:
      radial-gradient(ellipse 80% 50% at 50% -20%, rgba(0,113,227,0.04) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 100% 100%, rgba(120,90,220,0.03) 0%, transparent 50%);
    color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased;
  }
  ::selection { background: var(--cta); color: var(--white); }

  .dash-wrap { max-width: 900px; margin: 0 auto; padding: 0 40px 80px; }

  /* Auth/Pro gate */
  .gate { text-align: center; padding: 120px 24px; }
  .gate h1 { font-size: clamp(24px, 4vw, 32px); font-weight: 900; letter-spacing: -0.04em; margin-bottom: 12px; }
  .gate p { font-size: 15px; color: var(--text-3); margin-bottom: 32px; }
  .gate-btn {
    display: inline-flex; align-items: center; gap: 10px;
    padding: 14px 32px; background: var(--cta); color: var(--white); border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; text-decoration: none;
  }
  .gate-btn:hover { background: var(--cta-hover); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,113,227,0.2); }
  .gate-btn.ghost { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
  .gate-btn.ghost:hover { border-color: var(--text-4); box-shadow: var(--shadow-md); }

  /* Loading */
  .dash-loading { text-align: center; padding: 80px 24px; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--cta); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
  .dash-loading p { font-size: 14px; color: var(--text-4); }

  /* Section headers */
  .section-header { padding-top: 40px; margin-bottom: 20px; }
  .section-header h2 { font-size: 22px; font-weight: 900; letter-spacing: -0.03em; }
  .section-header p { font-size: 13px; color: var(--text-4); margin-top: 4px; }

  /* Account cards */
  .accounts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .account-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 24px; transition: all var(--transition); position: relative;
  }
  .account-card:hover { box-shadow: var(--shadow-sm); }
  .account-platform { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .account-icon {
    width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 16px; font-weight: 800; flex-shrink: 0;
  }
  .account-icon.twitter { background: #0f1419; color: #fff; }
  .account-icon.facebook { background: #1877F2; color: #fff; }
  .account-name { font-size: 15px; font-weight: 700; letter-spacing: -0.02em; }
  .account-username { font-size: 12px; color: var(--text-4); margin-top: 2px; }
  .account-status {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 12px; font-weight: 600; margin-bottom: 16px;
  }
  .status-dot {
    width: 7px; height: 7px; border-radius: 50%;
  }
  .status-dot.connected { background: var(--success); box-shadow: 0 0 0 3px rgba(52,199,89,0.2); animation: dotPulse 2s ease-in-out infinite; }
  .status-dot.disconnected { background: var(--text-5); }
  @keyframes dotPulse { 0%,100%{box-shadow:0 0 0 3px rgba(52,199,89,0.2)} 50%{box-shadow:0 0 0 5px rgba(52,199,89,0.1)} }
  .account-action-btn {
    display: block; width: 100%; padding: 10px; border-radius: 100px; border: 1px solid var(--border);
    background: var(--surface); font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600;
    color: var(--text-3); cursor: pointer; transition: all 0.2s; text-align: center; text-decoration: none;
  }
  .account-action-btn:hover { border-color: var(--text-4); color: var(--text); }
  .account-action-btn.connect { background: var(--cta); color: var(--white); border-color: var(--cta); }
  .account-action-btn.connect:hover { background: var(--cta-hover); border-color: var(--cta-hover); }
  .account-action-btn.danger:hover { border-color: var(--error); color: var(--error); }

  /* Tab filter */
  .tab-bar { display: flex; gap: 0; background: var(--accent-subtle); border-radius: 100px; padding: 4px; margin-bottom: 20px; max-width: 400px; }
  .tab-btn {
    flex: 1; padding: 8px 16px; border: none; background: transparent; color: var(--text-4);
    font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer;
    border-radius: 100px; transition: all 0.2s; text-align: center;
  }
  .tab-btn:hover { color: var(--text-3); }
  .tab-btn.active { background: var(--white); color: var(--text); box-shadow: var(--shadow-sm); }

  /* Post list */
  .post-list { display: flex; flex-direction: column; gap: 12px; }
  .post-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px; display: flex; gap: 16px; align-items: flex-start; transition: all var(--transition);
  }
  .post-card:hover { box-shadow: var(--shadow-sm); transform: translateY(-1px); }
  .post-thumb {
    width: 80px; height: 45px; border-radius: 6px; object-fit: cover; flex-shrink: 0;
    background: var(--accent-subtle);
  }
  .post-info { flex: 1; min-width: 0; }
  .post-video-title { font-size: 14px; font-weight: 700; letter-spacing: -0.02em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .post-meta { display: flex; align-items: center; gap: 8px; margin-top: 4px; flex-wrap: wrap; }
  .post-platform-badge {
    display: inline-block; padding: 2px 8px; border-radius: 100px;
    font-size: 10px; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase;
  }
  .post-platform-badge.twitter { background: #0f14190d; color: #0f1419; border: 1px solid #0f14191a; }
  .post-platform-badge.facebook { background: #1877F20d; color: #1877F2; border: 1px solid #1877F21a; }
  .post-time { font-size: 12px; color: var(--text-4); }
  .post-content-preview {
    font-size: 13px; color: var(--text-3); margin-top: 8px; line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  .post-status-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
  .post-status-badge {
    display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 100px;
    font-size: 11px; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase;
  }
  .post-status-badge.scheduled { background: rgba(0,113,227,0.08); color: var(--cta); border: 1px solid rgba(0,113,227,0.15); }
  .post-status-badge.posted { background: rgba(52,199,89,0.08); color: #1a8a38; border: 1px solid rgba(52,199,89,0.15); }
  .post-status-badge.failed { background: rgba(255,59,48,0.08); color: var(--error); border: 1px solid rgba(255,59,48,0.15); }
  .post-action-btn {
    padding: 4px 12px; border: 1px solid var(--border); border-radius: 100px; background: var(--surface);
    font-family: 'Outfit', sans-serif; font-size: 11px; font-weight: 600; color: var(--text-4);
    cursor: pointer; transition: all 0.2s;
  }
  .post-action-btn:hover { border-color: var(--text-4); color: var(--text-3); }
  .post-action-btn.danger:hover { border-color: var(--error); color: var(--error); }

  /* Empty state */
  .empty-posts { text-align: center; padding: 60px 24px; }
  .empty-posts p { font-size: 14px; color: var(--text-4); margin-bottom: 20px; }
  .empty-posts a { color: var(--cta); text-decoration: none; font-weight: 600; }
  .empty-posts a:hover { text-decoration: underline; }

  /* Toast */
  .dash-toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--text); color: var(--white); padding: 12px 28px; border-radius: 100px;
    font-size: 14px; font-weight: 600; z-index: 10000; opacity: 0; transition: all 0.3s; pointer-events: none;
  }
  .dash-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .hidden { display: none !important; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  @media (max-width: 600px) {
    .dash-wrap { padding: 0 24px 80px; }
    .accounts-grid { grid-template-columns: 1fr; }
    .tab-bar { max-width: 100%; }
  }
</style>
</head>
<body>
<script src="/nav.js"></script>
<script src="/pro.js"></script>

<div class="dash-wrap">
  <!-- Auth gate -->
  <div class="gate hidden" id="auth-gate">
    <h1>Social Dashboard</h1>
    <p>Sign in to connect your social accounts and schedule posts.</p>
    <a href="/api/auth/google" class="gate-btn ghost">Sign in with Google</a>
  </div>

  <!-- Pro gate -->
  <div class="gate hidden" id="pro-gate">
    <h1>Pro Feature</h1>
    <p>Connect social accounts and schedule posts with a Pro subscription.</p>
    <button class="gate-btn" onclick="TGPro.showUpgradeModal()">Upgrade to Pro</button>
  </div>

  <!-- Loading -->
  <div class="dash-loading hidden" id="dash-loading">
    <div class="spinner"></div>
    <p>Loading dashboard...</p>
  </div>

  <!-- Main content -->
  <div class="hidden" id="dash-content">
    <!-- Connected Accounts -->
    <div class="section-header">
      <h2>Connected Accounts</h2>
      <p>Link your social accounts to schedule posts directly.</p>
    </div>
    <div class="accounts-grid" id="accounts-grid"></div>

    <!-- Scheduled Posts -->
    <div class="section-header" style="padding-top:32px;">
      <h2>Scheduled Posts</h2>
    </div>
    <div class="tab-bar" id="post-tabs">
      <button class="tab-btn active" data-filter="all">All</button>
      <button class="tab-btn" data-filter="scheduled">Scheduled</button>
      <button class="tab-btn" data-filter="posted">Posted</button>
      <button class="tab-btn" data-filter="failed">Failed</button>
    </div>
    <div class="post-list" id="post-list"></div>
    <div class="empty-posts hidden" id="empty-posts">
      <p>No posts yet. <a href="/app">Generate content</a> and schedule it for posting.</p>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  var connections = [];
  var posts = [];
  var currentFilter = 'all';

  // Platform configs
  var PLATFORMS = {
    twitter: { name: 'X / Twitter', icon: '\uD835\uDD4F', cssClass: 'twitter' },
    facebook: { name: 'Facebook', icon: 'f', cssClass: 'facebook' },
  };

  // ==============================
  // INIT
  // ==============================
  TGUser.ready.then(function() {
    if (!TGUser.isSignedIn()) {
      document.getElementById('auth-gate').classList.remove('hidden');
      return;
    }
    if (!TGUser.isPro()) {
      document.getElementById('pro-gate').classList.remove('hidden');
      return;
    }
    loadDashboard();
  });

  // Handle ?connected= param (toast after OAuth return)
  var params = new URLSearchParams(window.location.search);
  var connectedPlatform = params.get('connected');
  if (connectedPlatform) {
    window.history.replaceState({}, '', '/dashboard');
    TGUser.ready.then(function() {
      showToast((PLATFORMS[connectedPlatform] ? PLATFORMS[connectedPlatform].name : connectedPlatform) + ' connected!');
    });
  }
  var socialError = params.get('social_error');
  if (socialError) {
    window.history.replaceState({}, '', '/dashboard');
    TGUser.ready.then(function() {
      showToast('Connection failed: ' + socialError);
    });
  }

  // ==============================
  // LOAD DATA
  // ==============================
  async function loadDashboard() {
    document.getElementById('dash-loading').classList.remove('hidden');

    try {
      var [connRes, postRes] = await Promise.all([
        fetch('/api/social', { credentials: 'same-origin' }),
        fetch('/api/schedule', { credentials: 'same-origin' }),
      ]);

      if (connRes.ok) {
        var connData = await connRes.json();
        connections = connData.connections || [];
      }
      if (postRes.ok) {
        var postData = await postRes.json();
        posts = postData.posts || [];
      }

      document.getElementById('dash-loading').classList.add('hidden');
      document.getElementById('dash-content').classList.remove('hidden');

      renderAccounts();
      renderPosts();
    } catch(e) {
      document.getElementById('dash-loading').classList.add('hidden');
      showToast('Failed to load dashboard');
    }
  }

  // ==============================
  // RENDER ACCOUNTS
  // ==============================
  function renderAccounts() {
    var grid = document.getElementById('accounts-grid');
    grid.innerHTML = '';

    ['twitter', 'facebook'].forEach(function(platform) {
      var config = PLATFORMS[platform];
      var conn = connections.find(function(c) { return c.platform === platform; });
      var card = document.createElement('div');
      card.className = 'account-card';

      if (conn) {
        card.innerHTML =
          '<div class="account-platform">' +
            '<div class="account-icon ' + config.cssClass + '">' + config.icon + '</div>' +
            '<div>' +
              '<div class="account-name">' + config.name + '</div>' +
              '<div class="account-username">' + escapeHtml(conn.platform_username || '') + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="account-status"><span class="status-dot connected"></span> Connected</div>' +
          '<button class="account-action-btn danger" data-disconnect="' + conn.id + '">Disconnect</button>';
      } else {
        card.innerHTML =
          '<div class="account-platform">' +
            '<div class="account-icon ' + config.cssClass + '">' + config.icon + '</div>' +
            '<div>' +
              '<div class="account-name">' + config.name + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="account-status"><span class="status-dot disconnected"></span> Not connected</div>' +
          '<a href="/api/social?action=connect&platform=' + platform + '" class="account-action-btn connect">Connect</a>';
      }

      grid.appendChild(card);
    });

    // Bind disconnect buttons
    grid.querySelectorAll('[data-disconnect]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        disconnectAccount(parseInt(this.getAttribute('data-disconnect'), 10), this);
      });
    });
  }

  async function disconnectAccount(id, btn) {
    btn.textContent = 'Disconnecting...';
    btn.disabled = true;

    try {
      var res = await fetch('/api/social?id=' + id, {
        method: 'DELETE',
        credentials: 'same-origin',
      });
      if (!res.ok) throw new Error('Disconnect failed');
      connections = connections.filter(function(c) { return c.id !== id; });
      renderAccounts();
      showToast('Account disconnected');
    } catch(e) {
      btn.textContent = 'Disconnect';
      btn.disabled = false;
      showToast('Failed to disconnect');
    }
  }

  // ==============================
  // RENDER POSTS
  // ==============================
  function renderPosts() {
    var list = document.getElementById('post-list');
    var empty = document.getElementById('empty-posts');
    list.innerHTML = '';

    var filtered = currentFilter === 'all'
      ? posts
      : posts.filter(function(p) { return p.status === currentFilter; });

    if (filtered.length === 0) {
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    filtered.forEach(function(p) {
      var card = document.createElement('div');
      card.className = 'post-card';
      card.id = 'post-' + p.id;

      var thumbSrc = p.video_thumb || '';
      var thumbHtml = thumbSrc
        ? '<img class="post-thumb" src="' + escapeAttr(thumbSrc) + '" alt="" loading="lazy">'
        : '<div class="post-thumb" style="display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--text-5);">No img</div>';

      var timeStr = '';
      if (p.scheduled_at) {
        var d = new Date(p.scheduled_at);
        timeStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' +
                  d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      }

      var statusClass = p.status || 'scheduled';
      var statusLabel = statusClass.charAt(0).toUpperCase() + statusClass.slice(1);

      var actionBtn = '';
      if (p.status === 'scheduled') {
        actionBtn = '<button class="post-action-btn danger" data-cancel="' + p.id + '">Cancel</button>';
      } else if (p.status === 'failed' && p.error_message) {
        actionBtn = '<span style="font-size:11px;color:var(--error);" title="' + escapeAttr(p.error_message) + '">Hover for error</span>';
      }

      var platformBadge = PLATFORMS[p.platform]
        ? '<span class="post-platform-badge ' + p.platform + '">' + PLATFORMS[p.platform].name + '</span>'
        : '<span class="post-platform-badge">' + escapeHtml(p.platform) + '</span>';

      var usernameText = p.platform_username ? ' &middot; ' + escapeHtml(p.platform_username) : '';

      card.innerHTML =
        thumbHtml +
        '<div class="post-info">' +
          '<div class="post-video-title">' + escapeHtml(p.video_title || 'Video') + '</div>' +
          '<div class="post-meta">' +
            platformBadge +
            '<span class="post-time">' + timeStr + usernameText + '</span>' +
          '</div>' +
          (p.scheduled_content ? '<div class="post-content-preview">' + escapeHtml(p.scheduled_content) + '</div>' : '') +
          '<div class="post-status-row">' +
            '<span class="post-status-badge ' + statusClass + '">' + statusLabel + '</span>' +
            actionBtn +
          '</div>' +
        '</div>';

      list.appendChild(card);
    });

    // Bind cancel buttons
    list.querySelectorAll('[data-cancel]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        cancelPost(parseInt(this.getAttribute('data-cancel'), 10), this);
      });
    });
  }

  async function cancelPost(id, btn) {
    btn.textContent = 'Cancelling...';
    btn.disabled = true;

    try {
      var res = await fetch('/api/schedule?id=' + id, {
        method: 'DELETE',
        credentials: 'same-origin',
      });
      if (!res.ok) throw new Error('Cancel failed');
      posts = posts.filter(function(p) { return p.id !== id; });
      renderPosts();
      showToast('Post cancelled');
    } catch(e) {
      btn.textContent = 'Cancel';
      btn.disabled = false;
      showToast('Failed to cancel post');
    }
  }

  // ==============================
  // TAB FILTER
  // ==============================
  document.getElementById('post-tabs').addEventListener('click', function(e) {
    var btn = e.target.closest('.tab-btn');
    if (!btn) return;
    currentFilter = btn.getAttribute('data-filter');
    document.querySelectorAll('#post-tabs .tab-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    renderPosts();
  });

  // ==============================
  // UTILS
  // ==============================
  function escapeHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }
  function escapeAttr(s) {
    return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
  function showToast(msg) {
    var toast = document.createElement('div');
    toast.className = 'dash-toast';
    toast.textContent = msg;
    document.body.appendChild(toast);
    requestAnimationFrame(function() { toast.classList.add('show'); });
    setTimeout(function() { toast.classList.remove('show'); setTimeout(function() { toast.remove(); }, 300); }, 3000);
  }
})();
</script>
<script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
