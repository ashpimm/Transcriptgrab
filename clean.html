<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transcript Cleaner — TranscriptGrab</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --white: #ffffff;
    --bg: #fafafa;
    --surface: #ffffff;
    --border: #e8e8e8;
    --border-light: #f0f0f0;
    --text: #111111;
    --text-2: #333333;
    --text-3: #666666;
    --text-4: #999999;
    --text-5: #bbbbbb;
    --accent: #111111;
    --accent-hover: #333333;
    --accent-subtle: #f5f5f5;
    --cta: #0071e3;
    --cta-hover: #0077ED;
    --success: #34c759;
    --error: #ff3b30;
    --radius: 16px;
    --radius-sm: 10px;
    --radius-xs: 6px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
    --transition: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Outfit', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
  ::selection { background: var(--text); color: var(--white); }
  .container { max-width: 720px; margin: 0 auto; padding: 0 24px; }

  .header { padding: 48px 0 40px; text-align: center; }
  .hero-title { font-size: clamp(36px, 6vw, 56px); font-weight: 900; letter-spacing: -0.03em; line-height: 1.1; color: var(--text); margin-bottom: 16px; }
  .hero-subtitle { font-size: 17px; font-weight: 400; color: var(--text-3); line-height: 1.5; max-width: 480px; margin: 0 auto; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 32px; margin-bottom: 16px; box-shadow: var(--shadow-sm); transition: box-shadow var(--transition); }
  .card:hover { box-shadow: var(--shadow-md); }
  .card-label { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-4); margin-bottom: 14px; display: block; }

  .text-input { width: 100%; padding: 16px 18px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'IBM Plex Mono', monospace; font-size: 14px; outline: none; transition: all var(--transition); }
  .text-input:focus { border-color: var(--text); box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
  .text-input::placeholder { color: var(--text-5); }
  textarea.text-input { min-height: 160px; resize: vertical; line-height: 1.8; }
  .input-hint { font-size: 12px; color: var(--text-4); margin-top: 10px; line-height: 1.5; }

  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 36px; border: none; border-radius: 100px; font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; transition: all var(--transition); width: 100%; letter-spacing: -0.01em; }
  .btn-dark { background: var(--accent); color: var(--white); }
  .btn-dark:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
  .btn-blue { background: var(--cta); color: var(--white); }
  .btn-blue:hover { background: var(--cta-hover); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,113,227,0.2); }
  .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
  .btn-ghost:hover { border-color: var(--text-4); background: var(--accent-subtle); }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
  .btn-sm { padding: 11px 24px; font-size: 13px; width: auto; }
  .btn:active { transform: translateY(0); }
  .btn-row { display: flex; gap: 8px; flex-wrap: wrap; }

  .option-group-label { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-4); margin-bottom: 10px; margin-top: 24px; }
  .option-group-label:first-child { margin-top: 0; }
  .radio-group { display: flex; flex-direction: column; gap: 6px; }
  .radio-opt { position: relative; cursor: pointer; display: block; }
  .radio-opt input { position: absolute; opacity: 0; width: 0; height: 0; }
  .radio-card { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-radius: var(--radius-sm); border: 1px solid var(--border-light); background: var(--white); transition: all 0.2s ease; }
  .radio-opt:hover .radio-card { border-color: var(--border); }
  .radio-opt input:checked + .radio-card { border-color: var(--text); box-shadow: 0 0 0 1px var(--text); }
  .r-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--border); flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
  .radio-opt input:checked + .radio-card .r-dot { border-color: var(--text); }
  .radio-opt input:checked + .radio-card .r-dot::after { content: ''; width: 8px; height: 8px; border-radius: 50%; background: var(--text); }
  .r-label { font-size: 14px; font-weight: 600; letter-spacing: -0.01em; }
  .r-desc { font-size: 12px; color: var(--text-4); margin-top: 1px; }

  .status { padding: 12px 16px; border-radius: var(--radius-xs); font-size: 13px; margin-top: 12px; display: none; font-weight: 500; }
  .status.show { display: block; animation: reveal 0.3s ease; }
  .status.error { background: #ff3b3010; border: 1px solid #ff3b3033; color: var(--error); }
  .status.success { background: #34c75910; border: 1px solid #34c75933; color: #1a8a38; }
  .status.info { background: #0071e310; border: 1px solid #0071e333; color: var(--cta); }

  .spinner { width: 16px; height: 16px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.7s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes reveal { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

  /* Input modes */
  .input-modes { display: flex; gap: 0; background: var(--accent-subtle); border-radius: 100px; padding: 4px; margin-bottom: 20px; }
  .input-mode { flex: 1; padding: 10px 16px; border: none; background: transparent; color: var(--text-3); font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 100px; transition: all var(--transition); text-align: center; }
  .input-mode:hover { color: var(--text); }
  .input-mode.active { background: var(--white); color: var(--text); box-shadow: var(--shadow-sm); }
  .input-area { display: none; }
  .input-area.active { display: block; }

  .drop-zone { border: 2px dashed var(--border); border-radius: var(--radius-sm); padding: 48px 24px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--bg); }
  .drop-zone:hover, .drop-zone.over { border-color: var(--text-4); background: var(--accent-subtle); }
  .drop-zone p { font-size: 14px; color: var(--text-3); margin-bottom: 4px; font-weight: 500; }
  .drop-zone span { font-size: 12px; color: var(--text-5); }

  .url-row { display: flex; gap: 8px; }
  .url-row .text-input { flex: 1; }

  /* Diff view */
  .diff-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
  .diff-panel { flex: 1; }
  .diff-label { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-4); margin-bottom: 8px; }
  .diff-box { background: var(--bg); border: 1px solid var(--border-light); border-radius: var(--radius-sm); padding: 18px; max-height: 300px; overflow-y: auto; font-family: 'IBM Plex Mono', monospace; font-size: 13px; line-height: 1.9; color: var(--text-3); white-space: pre-wrap; word-break: break-word; }
  .diff-box::-webkit-scrollbar { width: 4px; }
  .diff-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .result-stats { display: flex; gap: 24px; margin-bottom: 20px; flex-wrap: wrap; }
  .stat { text-align: center; }
  .stat-num { font-size: 24px; font-weight: 800; letter-spacing: -0.03em; color: var(--text); }
  .stat-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-4); margin-top: 2px; }

  .result-card { animation: reveal 0.5s ease; }

  footer { text-align: center; padding: 64px 0 40px; border-top: 1px solid var(--border-light); margin-top: 64px; }
  footer p { font-size: 12px; color: var(--text-5); }
  footer a { color: var(--text-4); text-decoration: none; font-weight: 500; }
  footer a:hover { color: var(--text); }

  @media (max-width: 600px) {
    .hero-title { font-size: 32px; }
    .header { padding: 32px 0 32px; }
    .card { padding: 24px; }
    .diff-container { grid-template-columns: 1fr; }
    .input-modes { flex-wrap: wrap; }
  }
</style>
</head>
<body>
<script src="/nav.js"></script>

<div class="container">
  <header class="header">
    <h1 class="hero-title">Clean up<br>any transcript.</h1>
    <p class="hero-subtitle">Remove filler words, fix grammar, and turn messy auto-generated transcripts into readable text.</p>
  </header>

  <!-- Input -->
  <div class="card">
    <span class="card-label">Transcript</span>
    <div class="input-modes">
      <button class="input-mode active" data-mode="paste">Paste Text</button>
      <button class="input-mode" data-mode="upload">Upload File</button>
      <button class="input-mode" data-mode="url">YouTube URL</button>
    </div>
    <div class="input-area active" id="input-paste">
      <textarea class="text-input" id="transcript-input" placeholder="Paste your transcript here..."></textarea>
    </div>
    <div class="input-area" id="input-upload">
      <div class="drop-zone" id="drop-zone">
        <p>Drop a transcript file here or click to browse</p>
        <span>.txt, .srt, .json, .csv</span>
        <input type="file" id="file-input" accept=".txt,.srt,.json,.csv">
      </div>
      <p class="input-hint" id="file-name" style="display:none;"></p>
    </div>
    <div class="input-area" id="input-url">
      <div class="url-row">
        <input type="text" class="text-input" id="url-input" placeholder="https://youtube.com/watch?v=...">
        <button class="btn btn-ghost btn-sm" id="btn-fetch" onclick="fetchFromUrl()">Fetch</button>
      </div>
      <p class="input-hint">We'll download the transcript and load it for cleaning.</p>
    </div>
  </div>

  <!-- Cleaning Level -->
  <div class="card">
    <div class="option-group-label" style="margin-top:0;">Cleaning Level</div>
    <div class="radio-group">
      <label class="radio-opt"><input type="radio" name="level" value="light" checked><div class="radio-card"><div class="r-dot"></div><div><div class="r-label">Light</div><div class="r-desc">Remove filler words (um, uh, like, you know). Runs instantly, no AI.</div></div></div></label>
      <label class="radio-opt"><input type="radio" name="level" value="medium"><div class="radio-card"><div class="r-dot"></div><div><div class="r-label">Medium</div><div class="r-desc">Remove fillers + fix punctuation and grammar. Uses AI.</div></div></div></label>
      <label class="radio-opt"><input type="radio" name="level" value="heavy"><div class="radio-card"><div class="r-dot"></div><div><div class="r-label">Heavy</div><div class="r-desc">Full cleanup + restructure into proper paragraphs. Uses AI.</div></div></div></label>
    </div>
  </div>

  <button class="btn btn-dark" id="btn-clean" onclick="handleClean()">Clean Transcript</button>
  <div class="pro-required-tag" id="pro-tag" style="display:none;">Pro subscription required for AI cleaning</div>
  <div id="clean-status" class="status"></div>

  <!-- Results -->
  <div id="result-section" style="display:none;">
    <div class="card result-card">
      <span class="card-label">Result</span>
      <div class="result-stats" id="result-stats"></div>
      <div class="diff-container">
        <div class="diff-panel">
          <div class="diff-label">Before</div>
          <div class="diff-box" id="diff-before"></div>
        </div>
        <div class="diff-panel">
          <div class="diff-label">After</div>
          <div class="diff-box" id="diff-after"></div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-dark btn-sm" onclick="downloadCleaned()">Download Cleaned</button>
        <button class="btn btn-ghost btn-sm" onclick="copyCleaned()">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <footer>
    <p>TranscriptGrab &nbsp;·&nbsp; <a href="/">Home</a> &nbsp;·&nbsp; <a href="/#pricing">Pricing</a> &nbsp;·&nbsp; <a href="#">Privacy</a> &nbsp;·&nbsp; <a href="#">Terms</a></p>
  </footer>
</div>

<script src="/pro.js"></script>
<script>
// Gate handler — light is free, medium/heavy require Pro
function handleClean(){
  var level=document.querySelector('input[name="level"]:checked').value;
  if(level==='light'){
    cleanTranscript();
  } else {
    TGPro.checkGate(cleanTranscript);
  }
}

// Update pro tag based on level selection
function updateProTag(){
  var level=document.querySelector('input[name="level"]:checked').value;
  var tag=document.getElementById('pro-tag');
  if(level==='light' || (window.TGPro && TGPro.isPro())){
    tag.style.display='none';
  } else {
    tag.style.display='flex';
  }
}
document.querySelectorAll('input[name="level"]').forEach(function(r){
  r.addEventListener('change',updateProTag);
});
setTimeout(updateProTag,100);

// ============================================
// INPUT MODE SWITCHING
// ============================================
document.querySelectorAll('.input-mode').forEach(function(btn){
  btn.addEventListener('click',function(){
    document.querySelectorAll('.input-mode').forEach(function(b){b.classList.remove('active');});
    this.classList.add('active');
    document.querySelectorAll('.input-area').forEach(function(a){a.classList.remove('active');});
    document.getElementById('input-'+this.dataset.mode).classList.add('active');
  });
});

// ============================================
// FILE UPLOAD
// ============================================
var dropZone=document.getElementById('drop-zone');
var fileInput=document.getElementById('file-input');

dropZone.addEventListener('click',function(){fileInput.click();});
dropZone.addEventListener('dragover',function(e){e.preventDefault();this.classList.add('over');});
dropZone.addEventListener('dragleave',function(){this.classList.remove('over');});
dropZone.addEventListener('drop',function(e){
  e.preventDefault();this.classList.remove('over');
  if(e.dataTransfer.files.length)handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change',function(){if(this.files.length)handleFile(this.files[0]);});

function handleFile(file){
  var reader=new FileReader();
  reader.onload=function(e){
    var parsed=parseTranscriptFile(e.target.result,file.name);
    document.getElementById('transcript-input').value=parsed.text;
    document.getElementById('file-name').style.display='block';
    document.getElementById('file-name').textContent='Loaded: '+file.name+' ('+parsed.text.split(/\s+/).length+' words)';
    // Switch to paste view to show loaded text
    document.querySelectorAll('.input-mode').forEach(function(b){b.classList.remove('active');});
    document.querySelector('[data-mode="paste"]').classList.add('active');
    document.querySelectorAll('.input-area').forEach(function(a){a.classList.remove('active');});
    document.getElementById('input-paste').classList.add('active');
  };
  reader.readAsText(file);
}

// ============================================
// FILE PARSERS
// ============================================
function parseTranscriptFile(content,filename){
  var ext=(filename||'').split('.').pop().toLowerCase();
  if(ext==='srt')return parseSRT(content);
  if(ext==='json')return parseJSONFile(content);
  if(ext==='csv')return parseCSVFile(content);
  return{text:content};
}

function parseSRT(content){
  var blocks=content.trim().split(/\n\n+/);
  var texts=[];
  for(var i=0;i<blocks.length;i++){
    var lines=blocks[i].split('\n');
    if(lines.length>=3)texts.push(lines.slice(2).join(' ').trim());
  }
  return{text:texts.join('\n')};
}

function parseJSONFile(content){
  try{
    var data=JSON.parse(content);
    if(data.segments&&Array.isArray(data.segments)){
      return{text:data.segments.map(function(s){return s.text;}).join('\n')};
    }
    return{text:content};
  }catch(e){return{text:content};}
}

function parseCSVFile(content){
  var lines=content.trim().split('\n');
  var texts=[];
  for(var i=1;i<lines.length;i++){
    var line=lines[i].trim();
    if(!line)continue;
    var match=line.match(/"([^"]*(?:""[^"]*)*)"/);
    if(match){texts.push(match[1].replace(/""/g,'"'));}
    else{
      // Handle unquoted CSV — take last comma-separated field or entire line
      var parts=line.split(',');
      var text=parts.length>2?parts.slice(2).join(',').trim():parts[parts.length-1].trim();
      if(text)texts.push(text);
    }
  }
  return{text:texts.length?texts.join('\n'):content};
}

// ============================================
// YOUTUBE URL FETCH
// ============================================
async function fetchFromUrl(){
  var url=document.getElementById('url-input').value.trim();
  if(!url){ss('clean-status','error','Enter a YouTube URL.');return;}
  var vidMatch=url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/);
  if(!vidMatch){ss('clean-status','error','Invalid YouTube URL.');return;}

  var btn=document.getElementById('btn-fetch');
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span>';
  try{
    var r=await fetch('/api/transcript?v='+vidMatch[1]+'&mode=single');
    var d=await r.json();
    if(!r.ok)throw new Error(d.error||'Failed to fetch transcript');
    var text=d.segments.map(function(s){return s.text;}).join('\n');
    document.getElementById('transcript-input').value=text;
    ss('clean-status','success','Loaded transcript: '+(d.title||vidMatch[1]));
    // Switch to paste view
    document.querySelectorAll('.input-mode').forEach(function(b){b.classList.remove('active');});
    document.querySelector('[data-mode="paste"]').classList.add('active');
    document.querySelectorAll('.input-area').forEach(function(a){a.classList.remove('active');});
    document.getElementById('input-paste').classList.add('active');
  }catch(e){ss('clean-status','error',e.message);}
  finally{btn.disabled=false;btn.textContent='Fetch';}
}

// ============================================
// LIGHT CLEANING (client-side regex)
// ============================================
function lightClean(text){
  var cleaned=text;
  // Filler words/phrases — remove when used as verbal tics
  var patterns=[
    /\b(um+|uh+|uhh+|hmm+|mmm+|er+)\b[,.]?\s*/gi,
    /\b(you know)\b[,.]?\s*/gi,
    /\b(sort of|kind of)\b\s+(?=\w)/gi,
    /\b(I mean)\b[,.]?\s*/gi,
    /\blike[,]\s+/gi,
    /\bright[,]\s+/gi,
  ];
  for(var i=0;i<patterns.length;i++){
    cleaned=cleaned.replace(patterns[i],'');
  }
  // Clean up artifacts
  cleaned=cleaned.replace(/\s{2,}/g,' ');
  cleaned=cleaned.replace(/,\s*,/g,',');
  cleaned=cleaned.replace(/^\s*,\s*/gm,'');
  cleaned=cleaned.replace(/\s+([.,!?])/g,'$1');
  return cleaned.trim();
}

// ============================================
// MAIN CLEAN FUNCTION
// ============================================
var _cleanedText='';

async function cleanTranscript(){
  var text=document.getElementById('transcript-input').value.trim();
  if(!text){ss('clean-status','error','Enter or upload a transcript first.');return;}

  var level=document.querySelector('input[name="level"]:checked').value;
  var btn=document.getElementById('btn-clean');
  hs('clean-status');
  document.getElementById('result-section').style.display='none';

  if(level==='light'){
    // Client-side cleaning
    var cleaned=lightClean(text);
    showResult(text,cleaned);
    return;
  }

  // Medium / Heavy — API call
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Cleaning...';
  try{
    var headers=Object.assign({'Content-Type':'application/json'},TGPro.authHeaders());
    var r=await fetch('/api/clean',{
      method:'POST',
      headers:headers,
      body:JSON.stringify({transcript:text,level:level})
    });
    var d=await r.json();
    if(r.status===402){TGPro.showUpgradeModal();throw new Error('Pro subscription required for AI cleaning');}
    if(!r.ok)throw new Error(d.error||'Cleaning failed');
    if(!d.cleaned)throw new Error('No cleaned text returned');
    showResult(text,d.cleaned);
  }catch(e){
    ss('clean-status','error',e.message);
  }finally{
    btn.disabled=false;btn.textContent='Clean Transcript';
  }
}

function showResult(original,cleaned){
  _cleanedText=cleaned;
  var origWords=original.split(/\s+/).length;
  var cleanWords=cleaned.split(/\s+/).length;
  var removed=origWords-cleanWords;
  var pct=origWords>0?Math.round((removed/origWords)*100):0;

  document.getElementById('result-stats').innerHTML=
    '<div class="stat"><div class="stat-num">'+origWords.toLocaleString()+'</div><div class="stat-label">Original Words</div></div>'+
    '<div class="stat"><div class="stat-num">'+cleanWords.toLocaleString()+'</div><div class="stat-label">Cleaned Words</div></div>'+
    '<div class="stat"><div class="stat-num">'+removed.toLocaleString()+'</div><div class="stat-label">Words Removed</div></div>'+
    '<div class="stat"><div class="stat-num">'+pct+'%</div><div class="stat-label">Reduction</div></div>';

  document.getElementById('diff-before').textContent=original.substring(0,3000)+(original.length>3000?'\n\n...':'');
  document.getElementById('diff-after').textContent=cleaned.substring(0,3000)+(cleaned.length>3000?'\n\n...':'');
  document.getElementById('result-section').style.display='block';
  document.getElementById('result-section').scrollIntoView({behavior:'smooth',block:'start'});
}

function downloadCleaned(){
  if(!_cleanedText)return;
  var blob=new Blob([_cleanedText],{type:'text/plain'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url;a.download='transcript-cleaned.txt';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function copyCleaned(){
  if(!_cleanedText)return;
  navigator.clipboard.writeText(_cleanedText).then(function(){
    ss('clean-status','success','Copied to clipboard');
    setTimeout(function(){hs('clean-status');},2000);
  });
}

// ============================================
// HELPERS
// ============================================
function ss(id,t,m){var e=document.getElementById(id);e.className='status show '+t;e.textContent=m;}
function hs(id){document.getElementById(id).className='status';}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
</script>
</body>
</html>
