<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TranscriptGrab â€” Generate Content</title>
<meta name="description" content="Paste a YouTube URL, get ready-to-post content for Twitter, LinkedIn, Facebook, Instagram, TikTok, blog, and more.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --white: #ffffff; --bg: #fafafa; --surface: #ffffff; --border: #e8e8e8; --border-light: #f0f0f0;
    --text: #111111; --text-2: #333333; --text-3: #666666; --text-4: #999999; --text-5: #bbbbbb;
    --accent: #111111; --accent-hover: #333333; --accent-subtle: #f5f5f5;
    --cta: #0071e3; --cta-hover: #0077ED;
    --success: #34c759; --error: #ff3b30;
    --radius: 16px; --radius-sm: 10px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.04); --shadow-md: 0 4px 16px rgba(0,0,0,0.06); --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
    --transition: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Outfit', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
  ::selection { background: var(--text); color: var(--white); }

  /* ===== COMPACT HERO ===== */
  .app-hero { text-align: center; padding: 48px 40px 8px; max-width: 800px; margin: 0 auto; }
  .app-hero h1 { font-size: clamp(28px, 5vw, 40px); font-weight: 900; letter-spacing: -0.04em; line-height: 1.1; margin-bottom: 10px; }
  .app-hero p { font-size: 15px; color: var(--text-3); line-height: 1.5; }

  /* ===== INPUT SECTION ===== */
  .input-section { max-width: 600px; margin: 24px auto 0; padding: 0 40px; display: flex; flex-direction: column; align-items: center; }
  .url-input {
    width: 100%; padding: 16px 20px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 100px; font-family: 'IBM Plex Mono', monospace; font-size: 14px; color: var(--text);
    outline: none; transition: all 0.2s; text-align: center;
  }
  .url-input:focus { border-color: var(--text); box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
  .url-input::placeholder { color: var(--text-5); }

  /* ===== FORMAT PICKER ===== */
  .format-picker { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 20px; }
  .format-pill {
    padding: 8px 18px; border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 500; color: var(--text-3);
    cursor: pointer; transition: all 0.2s; background: var(--surface); user-select: none;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .format-pill:hover { border-color: var(--text-4); color: var(--text-2); }
  .format-pill.selected { background: var(--text); color: var(--white); border-color: var(--text); }
  .format-pill .pill-icon { font-size: 14px; }

  .generate-btn {
    margin-top: 20px; padding: 16px 48px; background: var(--cta); color: var(--white); border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer;
    transition: all 0.2s; white-space: nowrap;
  }
  .generate-btn:hover { background: var(--cta-hover); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,113,227,0.2); }
  .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

  .input-hint { font-size: 12px; color: var(--text-5); margin-top: 12px; }

  /* ===== ERROR ===== */
  .error-msg { max-width: 600px; margin: 16px auto 0; padding: 0 40px; }
  .error-msg p { background: #fff5f5; border: 1px solid #fecaca; border-radius: var(--radius-sm); padding: 12px 16px; font-size: 13px; color: var(--error); }

  /* ===== PROCESSING STATE ===== */
  .processing { text-align: center; padding: 64px 24px; max-width: 640px; margin: 0 auto; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--cta); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .processing p { font-size: 15px; color: var(--text-3); }
  .processing .substep { font-size: 13px; color: var(--text-4); margin-top: 6px; }

  /* ===== RESULTS ===== */
  .results { max-width: 1000px; margin: 0 auto; padding: 0 40px 80px; }
  .results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-top: 32px; }
  .results-header h2 { font-size: 24px; font-weight: 800; letter-spacing: -0.03em; }
  .download-all-btn {
    padding: 10px 24px; background: var(--accent); color: var(--white); border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .download-all-btn:hover { background: var(--accent-hover); transform: translateY(-1px); }

  .platform-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

  .platform-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden; box-shadow: var(--shadow-sm); transition: all var(--transition);
  }
  .platform-card:hover { box-shadow: var(--shadow-md); }
  .platform-card.full-width { grid-column: 1 / -1; }

  .card-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; border-bottom: 1px solid var(--border-light);
  }
  .card-platform { display: flex; align-items: center; gap: 10px; }
  .card-icon { font-size: 18px; width: 28px; text-align: center; }
  .card-name { font-size: 14px; font-weight: 700; letter-spacing: -0.02em; }
  .card-copy-btn {
    padding: 6px 16px; background: var(--accent-subtle); border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 600; color: var(--text);
    cursor: pointer; transition: all 0.2s;
  }
  .card-copy-btn:hover { background: var(--border); }
  .card-copy-btn.copied { background: var(--success); color: var(--white); border-color: var(--success); }

  .card-body { padding: 20px; max-height: 400px; overflow-y: auto; }
  .card-body.tall { max-height: 600px; }

  /* Twitter thread */
  .tweet-list { list-style: none; }
  .tweet-item { padding: 14px 0; border-bottom: 1px solid var(--border-light); font-size: 14px; line-height: 1.5; color: var(--text-2); }
  .tweet-item:last-child { border-bottom: none; }
  .tweet-num { font-family: 'IBM Plex Mono', monospace; font-size: 11px; font-weight: 500; color: var(--text-4); display: block; margin-bottom: 4px; }

  /* Text content (LinkedIn, Facebook, Instagram, TikTok) */
  .content-text { font-size: 14px; line-height: 1.7; color: var(--text-2); white-space: pre-wrap; word-wrap: break-word; }

  /* Blog */
  .blog-title { font-size: 20px; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 16px; line-height: 1.3; }
  .blog-body { font-size: 14px; line-height: 1.8; color: var(--text-2); }
  .blog-body h2 { font-size: 18px; font-weight: 700; margin: 24px 0 8px; color: var(--text); }
  .blog-body h3 { font-size: 16px; font-weight: 700; margin: 20px 0 6px; color: var(--text); }
  .blog-body p { margin-bottom: 12px; }
  .blog-body ul, .blog-body ol { margin: 8px 0 12px 20px; }
  .blog-body li { margin-bottom: 4px; }

  /* TikTok */
  .tiktok-section-label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-4); margin-bottom: 6px; }
  .tiktok-section-label + .content-text { margin-bottom: 20px; }

  /* Quotes */
  .quote-list { display: flex; flex-direction: column; gap: 12px; }
  .quote-card {
    background: var(--accent-subtle); border-radius: var(--radius-sm); padding: 16px;
    position: relative;
  }
  .quote-text { font-size: 15px; font-weight: 500; line-height: 1.5; color: var(--text); margin-bottom: 8px; }
  .quote-meta { display: flex; align-items: center; justify-content: space-between; }
  .quote-ts { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--text-4); }
  .quote-copy {
    padding: 4px 12px; background: var(--white); border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 11px; font-weight: 600; color: var(--text-3);
    cursor: pointer; transition: all 0.2s;
  }
  .quote-copy:hover { border-color: var(--text-4); color: var(--text); }
  .quote-copy.copied { background: var(--success); color: var(--white); border-color: var(--success); }

  /* ===== PAYWALL ===== */
  .paywall-overlay {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(250,250,250,0.97);
    display: flex; align-items: center; justify-content: center;
    padding: 24px;
  }
  .paywall-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 24px;
    padding: 48px 40px; max-width: 480px; width: 100%; text-align: center;
    box-shadow: var(--shadow-lg); animation: tgSlideUp 0.3s ease;
  }
  .paywall-card h2 { font-size: 28px; font-weight: 900; letter-spacing: -0.03em; margin-bottom: 10px; line-height: 1.2; }
  .paywall-card p { font-size: 15px; color: var(--text-3); margin-bottom: 32px; line-height: 1.5; }
  .paywall-btns { display: flex; flex-direction: column; gap: 12px; }
  .paywall-btn {
    display: block; width: 100%; padding: 16px; border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer;
    transition: all 0.2s; text-decoration: none; text-align: center;
  }
  .paywall-btn.primary { background: var(--cta); color: var(--white); }
  .paywall-btn.primary:hover { background: var(--cta-hover); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,113,227,0.2); }
  .paywall-btn.secondary { background: var(--accent); color: var(--white); }
  .paywall-btn.secondary:hover { background: var(--accent-hover); transform: translateY(-1px); }
  .paywall-restore {
    display: block; width: 100%; background: none; border: none; padding: 14px;
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 500; color: var(--text-4);
    cursor: pointer; transition: color 0.2s; margin-top: 4px;
  }
  .paywall-restore:hover { color: var(--text-3); }

  /* ===== NEW VIDEO BTN ===== */
  .new-video-row { text-align: center; margin-top: 32px; }
  .new-video-btn {
    padding: 12px 28px; background: var(--accent-subtle); border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600; color: var(--text);
    cursor: pointer; transition: all 0.2s;
  }
  .new-video-btn:hover { background: var(--border); }

  /* ===== BULK MODE ===== */
  .mode-toggle { display: flex; justify-content: center; gap: 0; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 100px; overflow: hidden; width: fit-content; }
  .mode-btn {
    padding: 8px 24px; font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600;
    border: none; cursor: pointer; transition: all 0.2s; background: var(--surface); color: var(--text-3);
  }
  .mode-btn.active { background: var(--text); color: var(--white); }
  .mode-btn:hover:not(.active) { color: var(--text); }
  .mode-btn .pro-tag { font-size: 9px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; padding: 1px 5px; border-radius: 100px; background: var(--cta); color: var(--white); margin-left: 6px; vertical-align: middle; }

  .bulk-hint { font-size: 12px; color: var(--text-5); margin-top: 12px; }

  /* Bulk progress */
  .bulk-progress { max-width: 600px; margin: 0 auto; padding: 0 40px; }
  .bulk-progress-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .bulk-progress-header h3 { font-size: 16px; font-weight: 700; }
  .bulk-progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-bottom: 20px; }
  .bulk-progress-fill { height: 100%; background: var(--cta); border-radius: 2px; transition: width 0.3s ease; width: 0%; }
  .bulk-progress-status { font-size: 13px; color: var(--text-3); margin-bottom: 8px; }
  .bulk-video-list { list-style: none; display: flex; flex-direction: column; gap: 6px; max-height: 300px; overflow-y: auto; }
  .bulk-video-item {
    display: flex; align-items: center; gap: 10px; padding: 10px 14px;
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 13px;
  }
  .bulk-video-item .bv-status { width: 20px; text-align: center; flex-shrink: 0; }
  .bulk-video-item .bv-title { flex: 1; color: var(--text-2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .bulk-video-item.done { border-color: var(--success); }
  .bulk-video-item.active { border-color: var(--cta); }
  .bulk-video-item.error { border-color: var(--error); }

  /* Bulk results */
  .bulk-results { max-width: 1000px; margin: 0 auto; padding: 0 40px 80px; }
  .bulk-results-header { padding-top: 32px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
  .bulk-results-header h2 { font-size: 24px; font-weight: 800; letter-spacing: -0.03em; }
  .bulk-video-result { margin-bottom: 32px; }
  .bulk-video-result h3 { font-size: 18px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-light); }

  /* ===== HIDDEN ===== */
  .hidden { display: none !important; }

  /* ===== ANIMATIONS ===== */
  @keyframes tgSlideUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .fade-in { animation: fadeIn 0.4s ease; }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 600px) {
    .app-hero { padding: 32px 24px 4px; }
    .platform-grid { grid-template-columns: 1fr; }
    .results-header { flex-direction: column; gap: 12px; align-items: flex-start; }
    .paywall-card { padding: 36px 24px; }
  }
</style>
</head>
<body>
<script src="/nav.js"></script>
<script src="/pro.js"></script>

<!-- ===== HERO ===== -->
<section class="app-hero">
  <h1>Turn any YouTube video into content.</h1>
  <p>Paste a URL, pick your platforms, and generate.</p>
</section>

<!-- ===== INPUT ===== -->
<div class="input-section" id="input-section">
  <div class="mode-toggle hidden" id="mode-toggle">
    <button class="mode-btn active" data-mode="single" onclick="setMode('single')">Single Video</button>
    <button class="mode-btn" data-mode="bulk" onclick="setMode('bulk')">Bulk <span class="pro-tag">PRO</span></button>
  </div>

  <input type="text" class="url-input" id="url-input" placeholder="https://youtube.com/watch?v=..." autocomplete="off" spellcheck="false">

  <div class="format-picker" id="format-picker">
    <button class="format-pill selected" data-format="twitter"><span class="pill-icon">&#120143;</span> Twitter</button>
    <button class="format-pill selected" data-format="linkedin"><span class="pill-icon">in</span> LinkedIn</button>
    <button class="format-pill" data-format="facebook"><span class="pill-icon">f</span> Facebook</button>
    <button class="format-pill" data-format="instagram"><span class="pill-icon">&#128247;</span> Instagram</button>
    <button class="format-pill" data-format="tiktok"><span class="pill-icon">&#9835;</span> TikTok</button>
    <button class="format-pill" data-format="blog"><span class="pill-icon">&#9997;&#65039;</span> Blog</button>
    <button class="format-pill" data-format="quotes"><span class="pill-icon">&#128172;</span> Quotes</button>
    <button class="format-pill" data-format="transcript"><span class="pill-icon">&#128196;</span> Transcript</button>
  </div>

  <button class="generate-btn" id="generate-btn" onclick="handleGenerate()">Generate Content</button>
  <p class="input-hint" id="input-hint">Paste any YouTube video URL</p>
</div>

<!-- ===== BULK PROGRESS ===== -->
<div class="bulk-progress hidden" id="bulk-progress">
  <div class="bulk-progress-header">
    <h3>Bulk Processing</h3>
    <span id="bulk-counter" style="font-size:13px;color:#999;">0 / 0</span>
  </div>
  <div class="bulk-progress-bar"><div class="bulk-progress-fill" id="bulk-fill"></div></div>
  <p class="bulk-progress-status" id="bulk-status">Resolving videos...</p>
  <ul class="bulk-video-list" id="bulk-list"></ul>
</div>

<!-- ===== BULK RESULTS ===== -->
<div class="bulk-results hidden" id="bulk-results">
  <div class="bulk-results-header">
    <h2>Bulk Results</h2>
    <button class="download-all-btn" onclick="downloadBulkAll()">Download All</button>
  </div>
  <div id="bulk-results-content"></div>
  <div class="new-video-row">
    <button class="new-video-btn" onclick="resetApp()">Start over</button>
  </div>
</div>

<!-- ===== ERROR ===== -->
<div class="error-msg hidden" id="error-section">
  <p id="error-text"></p>
</div>

<!-- ===== PROCESSING ===== -->
<div class="processing hidden" id="processing-section">
  <div class="spinner"></div>
  <p id="processing-msg">Fetching transcript...</p>
  <p class="substep" id="processing-sub">This may take a moment</p>
</div>

<!-- ===== RESULTS ===== -->
<div class="results hidden" id="results-section">
  <div class="results-header">
    <h2 id="results-title">Your content is ready</h2>
    <button class="download-all-btn" onclick="downloadAll()">Download All</button>
  </div>
  <div class="platform-grid" id="platform-grid"></div>
  <div class="new-video-row">
    <button class="new-video-btn" onclick="resetApp()">Generate from another video</button>
  </div>
</div>

<script>
(function(){
  'use strict';

  // ==============================
  // STRIPE LINKS
  // ==============================
  var SINGLE_VIDEO_LINK = 'https://buy.stripe.com/test_bJe28tdAagezaP0bxtcAo05';
  var PRO_LINK = 'https://buy.stripe.com/test_aFa14panY5zVcX8595cAo02';

  // ==============================
  // FORMAT PICKER
  // ==============================
  var FORMATS = {
    twitter:   { name: 'Twitter / X', icon: '\u{1D54F}' },
    linkedin:  { name: 'LinkedIn',    icon: 'in' },
    facebook:  { name: 'Facebook',    icon: 'f' },
    instagram: { name: 'Instagram',   icon: '\u{1F4F7}' },
    tiktok:    { name: 'TikTok',      icon: '\u{266B}' },
    blog:      { name: 'Blog Post',   icon: '\u{270D}\u{FE0F}' },
    quotes:    { name: 'Key Quotes',  icon: '\u{1F4AC}' }
  };

  document.getElementById('format-picker').addEventListener('click', function(e) {
    var pill = e.target.closest('.format-pill');
    if (!pill) return;
    pill.classList.toggle('selected');
  });

  function getSelectedFormats() {
    var pills = document.querySelectorAll('.format-pill.selected');
    var formats = [];
    pills.forEach(function(p) { formats.push(p.getAttribute('data-format')); });
    return formats;
  }

  // ==============================
  // STATE
  // ==============================
  var currentResult = null;
  var currentTitle = '';
  var currentTranscript = '';
  var currentMode = 'single';
  var bulkResults = [];

  // ==============================
  // CREDIT HELPERS
  // ==============================
  function getFreeUsed() {
    try { return localStorage.getItem('tg_free_used') === 'true'; } catch(e) { return false; }
  }
  function setFreeUsed() {
    try { localStorage.setItem('tg_free_used', 'true'); } catch(e) {}
  }
  function getCredits() {
    try { return parseInt(localStorage.getItem('tg_credits') || '0', 10); } catch(e) { return 0; }
  }
  function setCredits(n) {
    try { localStorage.setItem('tg_credits', String(n)); } catch(e) {}
  }
  function canGenerate() {
    if (window.TGPro && TGPro.isPro()) return true;
    if (getCredits() > 0) return true;
    if (!getFreeUsed()) return true;
    return false;
  }
  function consumeCredit() {
    if (window.TGPro && TGPro.isPro()) return;
    if (!getFreeUsed()) { setFreeUsed(); return; }
    var c = getCredits();
    if (c > 0) setCredits(c - 1);
  }

  // ==============================
  // PAYMENT RETURN
  // ==============================
  // ==============================
  // PAYWALL
  // ==============================
  function showPaywall() {
    if (document.getElementById('paywall-overlay')) return;
    var div = document.createElement('div');
    div.className = 'paywall-overlay';
    div.id = 'paywall-overlay';
    div.innerHTML =
      '<div class="paywall-card">' +
        '<h2>Your free video is used</h2>' +
        '<p>Upgrade to keep generating social content from any YouTube video.</p>' +
        '<div class="paywall-btns">' +
          '<a href="' + SINGLE_VIDEO_LINK + '" class="paywall-btn secondary">Generate this video &mdash; $5</a>' +
          '<a href="' + PRO_LINK + '" class="paywall-btn primary">Go unlimited &mdash; $49/mo</a>' +
        '</div>' +
        '<button class="paywall-restore" onclick="TGPro.showRestoreModal()">Already subscribed? Restore access</button>' +
      '</div>';
    document.body.appendChild(div);
  }
  function hidePaywall() {
    var el = document.getElementById('paywall-overlay');
    if (el) el.remove();
  }

  // ==============================
  // TOAST
  // ==============================
  function showToast(msg) {
    if (window.TGPro && TGPro._showToast) { TGPro._showToast(msg); return; }
    var t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:12px 28px;border-radius:100px;font-family:Outfit,sans-serif;font-size:14px;font-weight:600;z-index:10000;';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(function(){ t.remove(); }, 3000);
  }

  // ==============================
  // EXTRACT VIDEO ID
  // ==============================
  function extractVideoId(url) {
    url = url.trim();
    if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
    try {
      var u = new URL(url);
      if (u.searchParams.get('v')) return u.searchParams.get('v');
      if (u.hostname === 'youtu.be') return u.pathname.split('/')[1];
      var m = u.pathname.match(/\/(shorts|embed|v)\/([a-zA-Z0-9_-]{11})/);
      if (m) return m[2];
    } catch(e) {}
    var r = url.match(/(?:v=|\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
    return r ? r[1] : null;
  }

  // ==============================
  // MODE TOGGLE
  // ==============================
  window.setMode = function(mode) {
    currentMode = mode;
    var btns = document.querySelectorAll('.mode-btn');
    btns.forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-mode') === mode);
    });
    var input = document.getElementById('url-input');
    var hint = document.getElementById('input-hint');
    if (mode === 'bulk') {
      input.placeholder = 'https://youtube.com/@channel or playlist URL...';
      hint.textContent = 'Paste a YouTube channel or playlist URL';
    } else {
      input.placeholder = 'https://youtube.com/watch?v=...';
      hint.textContent = 'Paste any YouTube video URL';
    }
  };

  // ==============================
  // GENERATE
  // ==============================
  window.handleGenerate = async function() {
    if (currentMode === 'bulk') { return handleBulkGenerate(); }

    var url = document.getElementById('url-input').value.trim();
    if (!url) { showError('Please paste a YouTube URL.'); return; }

    var videoId = extractVideoId(url);
    if (!videoId) { showError('Could not find a valid YouTube video ID in that URL.'); return; }

    var formats = getSelectedFormats();
    if (formats.length === 0) { showError('Select at least one format.'); return; }

    // Separate transcript (client-side) from AI formats
    var wantTranscript = formats.indexOf('transcript') !== -1;
    var aiFormats = formats.filter(function(f) { return f !== 'transcript'; });

    // Need credits for AI formats, transcript alone is free
    if (aiFormats.length > 0 && !canGenerate()) { showPaywall(); return; }

    hidePaywall();
    showProcessing('Fetching transcript...');

    try {
      // Step 1: Fetch transcript
      var tRes = await fetch('/api/transcript?v=' + videoId);
      var tData = await tRes.json();
      if (!tRes.ok || !tData.segments) {
        throw new Error(tData.error || 'Could not fetch transcript for this video.');
      }

      currentTitle = tData.title || 'Video';
      var transcriptText = tData.segments.map(function(s) { return s.text; }).join(' ');
      currentTranscript = tData.segments.map(function(s) {
        var mins = Math.floor(s.start / 60);
        var secs = Math.floor(s.start % 60);
        var ts = String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
        return '[' + ts + '] ' + s.text;
      }).join('\n');

      var gData = {};

      // Step 2: Generate AI formats (if any selected)
      if (aiFormats.length > 0) {
        var label = aiFormats.length === 1 ? aiFormats[0] : aiFormats.length + ' formats';
        updateProcessing('Generating ' + label + '...', 'This may take a moment');

        var gRes = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transcript: transcriptText, formats: aiFormats })
        });
        gData = await gRes.json();
        if (!gRes.ok) {
          throw new Error(gData.error || 'Content generation failed.');
        }

        consumeCredit();
      }

      if (wantTranscript) {
        gData._transcript = currentTranscript;
      }

      currentResult = gData;
      renderResults(gData, currentTitle);

    } catch(err) {
      hideProcessing();
      showError(err.message);
    }
  };

  // ==============================
  // BULK GENERATE
  // ==============================
  async function handleBulkGenerate() {
    var url = document.getElementById('url-input').value.trim();
    if (!url) { showError('Please paste a YouTube channel or playlist URL.'); return; }

    var formats = getSelectedFormats();
    if (formats.length === 0) { showError('Select at least one format.'); return; }
    var wantTranscript = formats.indexOf('transcript') !== -1;
    var aiFormats = formats.filter(function(f) { return f !== 'transcript'; });

    // Get subscription ID
    var proData = null;
    try { proData = JSON.parse(localStorage.getItem('tg_pro') || 'null'); } catch(e) {}
    var subId = proData && proData.subscriptionId ? proData.subscriptionId : '';
    if (!subId) { showError('Pro subscription required for bulk processing.'); return; }

    // Hide input, show bulk progress
    document.getElementById('input-section').classList.add('hidden');
    document.getElementById('error-section').classList.add('hidden');
    var progressSec = document.getElementById('bulk-progress');
    progressSec.classList.remove('hidden');
    document.getElementById('bulk-status').textContent = 'Resolving videos...';
    document.getElementById('bulk-counter').textContent = '0 / 0';
    document.getElementById('bulk-fill').style.width = '0%';
    document.getElementById('bulk-list').innerHTML = '';

    try {
      // Step 1: Resolve channel/playlist URL
      var rRes = await fetch('/api/resolve?url=' + encodeURIComponent(url));
      var rData = await rRes.json();
      if (!rRes.ok || !rData.videos || rData.videos.length === 0) {
        throw new Error(rData.error || 'No videos found at that URL.');
      }

      var videos = rData.videos;
      var total = videos.length;
      document.getElementById('bulk-counter').textContent = '0 / ' + total;

      // Populate video list
      var listEl = document.getElementById('bulk-list');
      videos.forEach(function(v) {
        var li = document.createElement('li');
        li.className = 'bulk-video-item';
        li.id = 'bv-' + v.videoId;
        li.innerHTML = '<span class="bv-status">\u2022</span><span class="bv-title">' + escapeHtml(v.title || v.videoId) + '</span>';
        listEl.appendChild(li);
      });

      // Step 2: Process each video
      bulkResults = [];
      for (var i = 0; i < total; i++) {
        var video = videos[i];
        var itemEl = document.getElementById('bv-' + video.videoId);
        if (itemEl) {
          itemEl.classList.add('active');
          itemEl.querySelector('.bv-status').innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;margin:0;display:inline-block;vertical-align:middle;"></div>';
        }

        document.getElementById('bulk-status').textContent = 'Processing: ' + (video.title || video.videoId);
        document.getElementById('bulk-counter').textContent = (i + 1) + ' / ' + total;
        document.getElementById('bulk-fill').style.width = ((i / total) * 100) + '%';

        try {
          // Fetch transcript (bulk mode with subscription header)
          var tRes = await fetch('/api/transcript?v=' + video.videoId + '&mode=bulk', {
            headers: { 'x-subscription-id': subId }
          });
          var tData = await tRes.json();
          if (!tRes.ok || !tData.segments) {
            throw new Error(tData.error || 'No transcript available');
          }

          var transcriptText = tData.segments.map(function(s) { return s.text; }).join(' ');
          var timestamped = tData.segments.map(function(s) {
            var mins = Math.floor(s.start / 60);
            var secs = Math.floor(s.start % 60);
            var ts = String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
            return '[' + ts + '] ' + s.text;
          }).join('\n');

          var gData = {};

          // Generate AI content (if any AI formats selected)
          if (aiFormats.length > 0) {
            var gRes = await fetch('/api/generate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ transcript: transcriptText, formats: aiFormats })
            });
            gData = await gRes.json();
            if (!gRes.ok) {
              throw new Error(gData.error || 'Generation failed');
            }
          }

          if (wantTranscript) {
            gData._transcript = timestamped;
          }

          bulkResults.push({ videoId: video.videoId, title: tData.title || video.title || video.videoId, result: gData });
          if (itemEl) { itemEl.classList.remove('active'); itemEl.classList.add('done'); itemEl.querySelector('.bv-status').innerHTML = '\u2713'; }

        } catch(videoErr) {
          bulkResults.push({ videoId: video.videoId, title: video.title || video.videoId, result: null, error: videoErr.message });
          if (itemEl) { itemEl.classList.remove('active'); itemEl.classList.add('error'); itemEl.querySelector('.bv-status').innerHTML = '\u2717'; }
        }
      }

      // Done
      document.getElementById('bulk-fill').style.width = '100%';
      document.getElementById('bulk-status').textContent = 'Complete! ' + bulkResults.filter(function(r){ return r.result; }).length + ' of ' + total + ' succeeded.';

      // Show results after short delay
      setTimeout(function() {
        progressSec.classList.add('hidden');
        renderBulkResults();
      }, 800);

    } catch(err) {
      progressSec.classList.add('hidden');
      document.getElementById('input-section').classList.remove('hidden');
      showError(err.message);
    }
  }

  function renderBulkResults() {
    var sec = document.getElementById('bulk-results');
    var content = document.getElementById('bulk-results-content');
    content.innerHTML = '';

    bulkResults.forEach(function(item) {
      var wrapper = document.createElement('div');
      wrapper.className = 'bulk-video-result';

      var h3 = document.createElement('h3');
      h3.textContent = item.title;
      wrapper.appendChild(h3);

      if (item.error || !item.result) {
        var errP = document.createElement('p');
        errP.style.cssText = 'color:var(--error);font-size:13px;';
        errP.textContent = 'Failed: ' + (item.error || 'Unknown error');
        wrapper.appendChild(errP);
      } else {
        var grid = document.createElement('div');
        grid.className = 'platform-grid';

        var data = item.result;
        if (data._transcript) grid.appendChild(buildTranscriptCard(data._transcript));
        if (data.twitter && data.twitter.tweets) grid.appendChild(buildTwitterCard(data.twitter.tweets));
        if (data.linkedin && data.linkedin.content) grid.appendChild(buildTextCard('LinkedIn', 'in', data.linkedin.content));
        if (data.facebook && data.facebook.content) grid.appendChild(buildTextCard('Facebook', 'f', data.facebook.content));
        if (data.instagram && data.instagram.content) grid.appendChild(buildTextCard('Instagram', '\u{1F4F7}', data.instagram.content));
        if (data.tiktok) grid.appendChild(buildTikTokCard(data.tiktok));
        if (data.blog) grid.appendChild(buildBlogCard(data.blog));
        if (data.quotes && data.quotes.length) grid.appendChild(buildQuotesCard(data.quotes));

        wrapper.appendChild(grid);
      }

      content.appendChild(wrapper);
    });

    sec.classList.remove('hidden');
    sec.classList.add('fade-in');
  }

  window.downloadBulkAll = function() {
    if (!bulkResults.length) return;
    var parts = [];
    parts.push('=== BULK EXPORT ===\n');
    parts.push('Generated by TranscriptGrab\n');
    parts.push(bulkResults.length + ' videos processed\n\n');

    bulkResults.forEach(function(item, idx) {
      parts.push('========================================\n');
      parts.push('VIDEO ' + (idx + 1) + ': ' + item.title + '\n');
      parts.push('========================================\n\n');

      if (item.error || !item.result) {
        parts.push('FAILED: ' + (item.error || 'Unknown error') + '\n\n');
        return;
      }

      var data = item.result;
      if (data._transcript) parts.push('--- TRANSCRIPT ---\n\n' + data._transcript + '\n\n');
      if (data.twitter && data.twitter.tweets) {
        parts.push('--- TWITTER THREAD ---\n\n');
        data.twitter.tweets.forEach(function(t, i) { parts.push((i+1) + '/ ' + t + '\n\n'); });
      }
      if (data.linkedin) parts.push('--- LINKEDIN ---\n\n' + data.linkedin.content + '\n\n');
      if (data.facebook) parts.push('--- FACEBOOK ---\n\n' + data.facebook.content + '\n\n');
      if (data.instagram) parts.push('--- INSTAGRAM ---\n\n' + data.instagram.content + '\n\n');
      if (data.tiktok) parts.push('--- TIKTOK ---\n\nCaption:\n' + (data.tiktok.caption||'') + '\n\nScript:\n' + (data.tiktok.script||'') + '\n\n');
      if (data.blog) parts.push('--- BLOG POST ---\n\n# ' + (data.blog.title||'') + '\n\n' + (data.blog.content||'') + '\n\n');
      if (data.quotes) {
        parts.push('--- KEY QUOTES ---\n\n');
        data.quotes.forEach(function(q) { parts.push('"' + q.text + '"' + (q.timestamp ? ' [' + q.timestamp + ']' : '') + '\n\n'); });
      }
      parts.push('\n');
    });

    var blob = new Blob([parts.join('')], { type: 'text/plain' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'transcriptgrab-bulk-export.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // ==============================
  // UI HELPERS
  // ==============================
  function showError(msg) {
    var el = document.getElementById('error-section');
    document.getElementById('error-text').textContent = msg;
    el.classList.remove('hidden');
    setTimeout(function(){ el.classList.add('hidden'); }, 8000);
  }

  function showProcessing(msg) {
    document.getElementById('input-section').classList.add('hidden');
    document.getElementById('results-section').classList.add('hidden');
    document.getElementById('error-section').classList.add('hidden');
    var sec = document.getElementById('processing-section');
    document.getElementById('processing-msg').textContent = msg;
    document.getElementById('processing-sub').textContent = 'This may take a moment';
    sec.classList.remove('hidden');
  }
  function updateProcessing(msg, sub) {
    document.getElementById('processing-msg').textContent = msg;
    if (sub) document.getElementById('processing-sub').textContent = sub;
  }
  function hideProcessing() {
    document.getElementById('processing-section').classList.add('hidden');
    document.getElementById('input-section').classList.remove('hidden');
  }

  // ==============================
  // RENDER RESULTS
  // ==============================
  function renderResults(data, title) {
    document.getElementById('processing-section').classList.add('hidden');
    document.getElementById('input-section').classList.add('hidden');
    var sec = document.getElementById('results-section');
    sec.classList.remove('hidden');
    sec.classList.add('fade-in');
    document.getElementById('results-title').textContent = title;

    var grid = document.getElementById('platform-grid');
    grid.innerHTML = '';

    if (data._transcript) {
      grid.appendChild(buildTranscriptCard(data._transcript));
    }
    if (data.twitter && data.twitter.tweets) {
      grid.appendChild(buildTwitterCard(data.twitter.tweets));
    }
    if (data.linkedin && data.linkedin.content) {
      grid.appendChild(buildTextCard('LinkedIn', 'in', data.linkedin.content));
    }
    if (data.facebook && data.facebook.content) {
      grid.appendChild(buildTextCard('Facebook', 'f', data.facebook.content));
    }
    if (data.instagram && data.instagram.content) {
      grid.appendChild(buildTextCard('Instagram', '\u{1F4F7}', data.instagram.content));
    }
    if (data.tiktok) {
      grid.appendChild(buildTikTokCard(data.tiktok));
    }
    if (data.blog) {
      grid.appendChild(buildBlogCard(data.blog));
    }
    if (data.quotes && data.quotes.length) {
      grid.appendChild(buildQuotesCard(data.quotes));
    }
  }

  function buildTwitterCard(tweets) {
    var card = makeCard('Twitter / X', '\u{1D54F}', tweets.join('\n\n'));
    var body = card.querySelector('.card-body');
    var list = document.createElement('ol');
    list.className = 'tweet-list';
    tweets.forEach(function(t, i) {
      var li = document.createElement('li');
      li.className = 'tweet-item';
      li.innerHTML = '<span class="tweet-num">' + (i+1) + '/' + tweets.length + '</span>' + escapeHtml(t);
      list.appendChild(li);
    });
    body.innerHTML = '';
    body.appendChild(list);
    return card;
  }

  function buildTranscriptCard(text) {
    var card = makeCard('Transcript', '\u{1F4C4}', text);
    card.classList.add('full-width');
    var body = card.querySelector('.card-body');
    body.classList.add('tall');
    var pre = document.createElement('div');
    pre.className = 'content-text';
    pre.style.fontFamily = '"IBM Plex Mono", monospace';
    pre.style.fontSize = '12px';
    pre.textContent = text;
    body.innerHTML = '';
    body.appendChild(pre);
    return card;
  }

  function buildTextCard(name, icon, content) {
    var card = makeCard(name, icon, content);
    var body = card.querySelector('.card-body');
    var pre = document.createElement('div');
    pre.className = 'content-text';
    pre.textContent = content;
    body.innerHTML = '';
    body.appendChild(pre);
    return card;
  }

  function buildTikTokCard(tiktok) {
    var copyText = (tiktok.caption || '') + '\n\n---\n\n' + (tiktok.script || '');
    var card = makeCard('TikTok', '\u{266B}', copyText);
    var body = card.querySelector('.card-body');
    body.innerHTML =
      '<div class="tiktok-section-label">Caption</div>' +
      '<div class="content-text">' + escapeHtml(tiktok.caption || '') + '</div>' +
      '<div class="tiktok-section-label" style="margin-top:20px">Voiceover Script</div>' +
      '<div class="content-text">' + escapeHtml(tiktok.script || '') + '</div>';
    return card;
  }

  function buildBlogCard(blog) {
    var fullText = '# ' + (blog.title || '') + '\n\n' + (blog.content || '');
    var card = makeCard('Blog Post', '\u{270D}\u{FE0F}', fullText);
    card.classList.add('full-width');
    var body = card.querySelector('.card-body');
    body.classList.add('tall');
    body.innerHTML = '<div class="blog-title">' + escapeHtml(blog.title || '') + '</div><div class="blog-body">' + renderMarkdown(blog.content || '') + '</div>';
    return card;
  }

  function buildQuotesCard(quotes) {
    var allText = quotes.map(function(q) { return '"' + q.text + '"'; }).join('\n\n');
    var card = makeCard('Key Quotes', '\u{1F4AC}', allText);
    card.classList.add('full-width');
    var body = card.querySelector('.card-body');
    body.innerHTML = '';
    var list = document.createElement('div');
    list.className = 'quote-list';
    quotes.forEach(function(q) {
      var qc = document.createElement('div');
      qc.className = 'quote-card';
      qc.innerHTML =
        '<div class="quote-text">"' + escapeHtml(q.text) + '"</div>' +
        '<div class="quote-meta">' +
          '<span class="quote-ts">' + escapeHtml(q.timestamp || '') + '</span>' +
          '<button class="quote-copy" onclick="copyText(this, ' + escapeAttr(JSON.stringify(q.tweet || q.text)) + ')">Copy</button>' +
        '</div>';
      list.appendChild(qc);
    });
    body.appendChild(list);
    return card;
  }

  function makeCard(name, icon, copyContent) {
    var card = document.createElement('div');
    card.className = 'platform-card';
    card.innerHTML =
      '<div class="card-header">' +
        '<div class="card-platform"><span class="card-icon">' + icon + '</span><span class="card-name">' + name + '</span></div>' +
        '<button class="card-copy-btn" onclick="copyText(this, null, this.closest(\'.platform-card\'))">Copy</button>' +
      '</div>' +
      '<div class="card-body"></div>';
    card._copyContent = copyContent;
    return card;
  }

  // ==============================
  // COPY
  // ==============================
  window.copyText = function(btn, text, cardEl) {
    if (!text && cardEl) text = cardEl._copyContent;
    if (!text) return;
    navigator.clipboard.writeText(text).then(function() {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(function() { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
    });
  };

  // ==============================
  // DOWNLOAD ALL
  // ==============================
  window.downloadAll = function() {
    if (!currentResult) return;
    var parts = [];
    var title = currentTitle || 'Video';
    parts.push('=== ' + title + ' ===\n');
    parts.push('Generated by TranscriptGrab\n\n');

    if (currentResult._transcript) {
      parts.push('--- TRANSCRIPT ---\n\n' + currentResult._transcript + '\n\n');
    }
    if (currentResult.twitter && currentResult.twitter.tweets) {
      parts.push('--- TWITTER THREAD ---\n\n');
      currentResult.twitter.tweets.forEach(function(t, i) {
        parts.push((i+1) + '/ ' + t + '\n\n');
      });
    }
    if (currentResult.linkedin) {
      parts.push('\n--- LINKEDIN ---\n\n' + currentResult.linkedin.content + '\n\n');
    }
    if (currentResult.facebook) {
      parts.push('\n--- FACEBOOK ---\n\n' + currentResult.facebook.content + '\n\n');
    }
    if (currentResult.instagram) {
      parts.push('\n--- INSTAGRAM ---\n\n' + currentResult.instagram.content + '\n\n');
    }
    if (currentResult.tiktok) {
      parts.push('\n--- TIKTOK ---\n\nCaption:\n' + (currentResult.tiktok.caption||'') + '\n\nScript:\n' + (currentResult.tiktok.script||'') + '\n\n');
    }
    if (currentResult.blog) {
      parts.push('\n--- BLOG POST ---\n\n# ' + (currentResult.blog.title||'') + '\n\n' + (currentResult.blog.content||'') + '\n\n');
    }
    if (currentResult.quotes) {
      parts.push('\n--- KEY QUOTES ---\n\n');
      currentResult.quotes.forEach(function(q) {
        parts.push('"' + q.text + '"' + (q.timestamp ? ' [' + q.timestamp + ']' : '') + '\n\n');
      });
    }

    var blob = new Blob([parts.join('')], { type: 'text/plain' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = slugify(title) + '-content.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // ==============================
  // RESET
  // ==============================
  window.resetApp = function() {
    currentResult = null;
    currentTitle = '';
    currentTranscript = '';
    bulkResults = [];
    document.getElementById('results-section').classList.add('hidden');
    document.getElementById('bulk-progress').classList.add('hidden');
    document.getElementById('bulk-results').classList.add('hidden');
    document.getElementById('input-section').classList.remove('hidden');
    document.getElementById('url-input').value = '';
    document.getElementById('url-input').focus();
  };

  // ==============================
  // UTILS
  // ==============================
  function escapeHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }
  function escapeAttr(s) {
    return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
  }
  function slugify(s) {
    return s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').substring(0, 60);
  }

  function renderMarkdown(md) {
    return md
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/^# (.+)$/gm, '<h2>$1</h2>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
      .replace(/\n\n/g, '</p><p>')
      .replace(/^/, '<p>')
      .replace(/$/, '</p>');
  }

  // ==============================
  // ENTER KEY
  // ==============================
  document.getElementById('url-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') handleGenerate();
  });

  // ==============================
  // INIT
  // ==============================
  handleCreditReturn();

  // Show bulk toggle for Pro users (slight delay for pro.js to load)
  setTimeout(function() {
    if (window.TGPro && TGPro.isPro()) {
      document.getElementById('mode-toggle').classList.remove('hidden');
    }
  }, 150);

})();
</script>
</body>
</html>
