<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TranscriptGrab — Extract Transcript & Generate Content</title>
<meta name="description" content="Paste a YouTube, TikTok, or Instagram URL to extract the transcript. AI generates tweets, LinkedIn posts, blog articles, Instagram captions & more from your video transcript.">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="TranscriptGrab — Extract Transcript & Generate Content">
<meta property="og:description" content="Paste a YouTube, TikTok, or Instagram URL to extract the transcript. AI generates tweets, LinkedIn posts, blog articles & more from your video.">
<meta property="og:url" content="https://transcriptgrab.vercel.app/app">
<meta property="og:site_name" content="TranscriptGrab">
<meta property="og:image" content="https://transcriptgrab.vercel.app/og-image.png?v=3">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="TranscriptGrab — Turn video transcripts into ready-to-post content">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="TranscriptGrab — Extract Transcript & Generate Content">
<meta name="twitter:description" content="Paste a video URL to extract the transcript. AI generates tweets, LinkedIn posts, blogs & more.">
<meta name="twitter:image" content="https://transcriptgrab.vercel.app/og-image.png?v=3">
<meta name="twitter:image:alt" content="TranscriptGrab — Turn video transcripts into ready-to-post content">

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>T</text></svg>">
<link rel="canonical" href="https://transcriptgrab.vercel.app/app">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/content-cards.css">
<style>
  :root {
    --white: #ffffff; --bg: #f8f9fb; --surface: #ffffff; --border: #e5e7ec; --border-light: #eef0f4;
    --text: #0f1115; --text-2: #2d3039; --text-3: #5c5f6a; --text-4: #8f929d; --text-5: #b5b8c2;
    --accent: #0f1115; --accent-hover: #2d3039; --accent-subtle: #f3f4f7;
    --cta: #0071e3; --cta-hover: #0077ED;
    --success: #34c759; --error: #ff3b30;
    --radius: 16px; --radius-sm: 10px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.03), 0 1px 2px rgba(0,0,0,0.02);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.03);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.07), 0 2px 8px rgba(0,0,0,0.03);
    --transition: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Outfit', -apple-system, sans-serif;
    background: var(--bg);
    background-image:
      radial-gradient(ellipse 80% 50% at 50% -20%, rgba(0,113,227,0.04) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 100% 100%, rgba(120,90,220,0.03) 0%, transparent 50%);
    color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }
  ::selection { background: var(--cta); color: var(--white); }

  /* ===== COMPACT HERO ===== */
  .app-hero { text-align: center; padding: 48px 40px 8px; max-width: 800px; margin: 0 auto; }
  .app-hero h1 { font-size: clamp(28px, 5vw, 40px); font-weight: 900; letter-spacing: -0.04em; line-height: 1.1; margin-bottom: 10px; }
  .app-hero p { font-size: 15px; color: var(--text-3); line-height: 1.5; }

  /* ===== INPUT SECTION ===== */
  .input-section { max-width: 600px; margin: 24px auto 0; padding: 0 40px; display: flex; flex-direction: column; align-items: center; }
  .url-input-wrap {
    width: 100%; position: relative; display: flex; align-items: center;
  }
  .url-input {
    width: 100%; padding: 16px 52px 16px 20px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 100px; font-family: 'IBM Plex Mono', monospace; font-size: 14px; color: var(--text);
    outline: none; transition: all 0.2s; text-align: center;
  }
  .url-input:focus { border-color: var(--cta); box-shadow: 0 0 0 3px rgba(0,113,227,0.1); }
  .url-input::placeholder { color: var(--text-5); }
  .paste-btn {
    position: absolute; right: 6px; width: 40px; height: 40px; border-radius: 50%;
    border: none; background: var(--accent-subtle); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; color: var(--text-3);
  }
  .paste-btn:hover { background: var(--border); color: var(--text); }
  .paste-btn.pasted { background: var(--success); color: var(--white); }
  .paste-btn svg { width: 18px; height: 18px; }

  /* ===== FORMAT PICKER ===== */
  .format-picker { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
  .format-pill {
    padding: 8px 18px; border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 500; color: var(--text-3);
    cursor: pointer; transition: all 0.2s; background: var(--surface); user-select: none;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .format-pill:hover { border-color: var(--text-4); color: var(--text-2); }
  .format-pill.selected { background: var(--text); color: var(--white); border-color: var(--text); }
  .format-pill .pill-icon { font-size: 14px; }

  /* ===== LANGUAGE SELECTOR ===== */
  .lang-row { display: flex; align-items: center; gap: 8px; margin-top: 16px; }
  .lang-label { font-size: 12px; font-weight: 500; color: var(--text-4); white-space: nowrap; }
  .lang-select {
    padding: 6px 28px 6px 12px; border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 500; color: var(--text-2);
    background: var(--surface); cursor: pointer; outline: none; transition: border-color 0.2s;
    appearance: none; -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238f929d' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center;
  }
  .lang-select:focus { border-color: var(--cta); }

  .generate-btn {
    margin-top: 20px; padding: 16px 48px; background: var(--cta); color: var(--white); border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer;
    transition: all 0.2s; white-space: nowrap;
  }
  .generate-btn:hover { background: var(--cta-hover); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,113,227,0.2); }
  .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

  .credit-indicator { font-size: 12px; color: var(--text-5); margin-top: 10px; }
  .credit-indicator:empty { display: none; }
  .credit-indicator a { color: var(--cta); text-decoration: none; font-weight: 500; }
  .credit-indicator a:hover { text-decoration: underline; }

  .input-hint { font-size: 12px; color: var(--text-5); margin-top: 12px; }

  /* ===== ERROR ===== */
  .error-msg { max-width: 600px; margin: 16px auto 0; padding: 0 40px; }
  .error-msg p { background: #fff5f5; border: 1px solid #fecaca; border-radius: var(--radius-sm); padding: 12px 16px; font-size: 13px; color: var(--error); }

  /* ===== PROCESSING STATE ===== */
  .processing { text-align: center; padding: 64px 24px; max-width: 640px; margin: 0 auto; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--cta); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .processing p { font-size: 15px; color: var(--text-3); }
  .processing .substep { font-size: 13px; color: var(--text-4); margin-top: 6px; }

  /* ===== RESULTS ===== */
  .results { max-width: 1200px; margin: 0 auto; padding: 0 40px 80px; }
  .results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-top: 32px; }
  .results-header h2 { font-size: 24px; font-weight: 800; letter-spacing: -0.03em; }
  .download-all-btn {
    padding: 10px 24px; background: var(--accent); color: var(--white); border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .download-all-btn:hover { background: var(--accent-hover); transform: translateY(-1px); }

  /* ===== PAYWALL ===== */
  .paywall-overlay {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(15,17,21,0.3); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    padding: 24px; animation: fadeIn 0.2s ease;
  }
  .paywall-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 24px;
    padding: 48px 40px; max-width: 480px; width: 100%; text-align: center;
    box-shadow: 0 24px 80px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.06); animation: tgSlideUp 0.3s ease;
  }
  .paywall-card h2 { font-size: 28px; font-weight: 900; letter-spacing: -0.03em; margin-bottom: 10px; line-height: 1.2; }
  .paywall-card p { font-size: 15px; color: var(--text-3); margin-bottom: 32px; line-height: 1.5; }
  .paywall-btns { display: flex; flex-direction: column; gap: 12px; }
  .paywall-btn {
    display: block; width: 100%; padding: 16px; border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer;
    transition: all 0.2s; text-decoration: none; text-align: center;
  }
  .paywall-btn.primary { background: var(--cta); color: var(--white); }
  .paywall-btn.primary:hover { background: var(--cta-hover); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,113,227,0.2); }
  .paywall-btn.secondary { background: var(--accent); color: var(--white); }
  .paywall-btn.secondary:hover { background: var(--accent-hover); transform: translateY(-1px); }
  .paywall-restore {
    display: block; width: 100%; background: none; border: none; padding: 14px;
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 500; color: var(--text-4);
    cursor: pointer; transition: color 0.2s; margin-top: 4px;
  }
  .paywall-restore:hover { color: var(--text-3); }

  /* ===== NEW VIDEO BTN ===== */
  .new-video-row { text-align: center; margin-top: 32px; }
  .new-video-btn {
    padding: 12px 28px; background: var(--accent-subtle); border: 1px solid var(--border); border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600; color: var(--text);
    cursor: pointer; transition: all 0.2s;
  }
  .new-video-btn:hover { background: var(--border); }

  /* ===== SAVED BADGE ===== */
  .saved-badge {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 13px; font-weight: 600; color: var(--success);
    padding: 6px 16px; border: 1px solid rgba(52,199,89,0.2); border-radius: 100px;
    background: rgba(52,199,89,0.06);
  }
  .saved-badge a { color: var(--cta); text-decoration: none; font-weight: 600; margin-left: 4px; }
  .saved-badge a:hover { text-decoration: underline; }

  /* ===== HIDDEN ===== */
  /* ===== SCHEDULE MODAL ===== */
  .schedule-overlay {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(15,17,21,0.3); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    padding: 24px; animation: fadeIn 0.2s ease;
  }
  .schedule-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    padding: 36px 32px; max-width: 480px; width: 100%; text-align: left;
    box-shadow: 0 24px 80px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.06); animation: tgSlideUp 0.3s ease;
  }
  .schedule-card h3 { font-size: 20px; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 4px; }
  .schedule-card .schedule-subtitle { font-size: 13px; color: var(--text-3); margin-bottom: 20px; }
  .schedule-label { font-size: 13px; font-weight: 600; color: var(--text-2); margin-bottom: 8px; display: block; }
  .schedule-select, .schedule-datetime {
    width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm);
    font-family: 'Outfit', sans-serif; font-size: 14px; color: var(--text);
    background: var(--bg); outline: none; transition: border-color 0.2s; margin-bottom: 16px;
  }
  .schedule-select:focus, .schedule-datetime:focus { border-color: var(--cta); }
  .schedule-textarea {
    width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm);
    font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: var(--text);
    background: var(--bg); outline: none; transition: border-color 0.2s; margin-bottom: 16px;
    min-height: 120px; resize: vertical; line-height: 1.6;
  }
  .schedule-textarea:focus { border-color: var(--cta); }
  .schedule-btns { display: flex; gap: 10px; justify-content: flex-end; }
  .schedule-btn {
    padding: 12px 28px; border: none; border-radius: 100px;
    font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .schedule-btn.cancel { background: var(--accent-subtle); color: var(--text-3); border: 1px solid var(--border); }
  .schedule-btn.cancel:hover { background: var(--border); color: var(--text); }
  .schedule-btn.submit { background: var(--cta); color: var(--white); }
  .schedule-btn.submit:hover { background: var(--cta-hover); transform: translateY(-1px); }
  .schedule-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .schedule-error { font-size: 12px; color: var(--error); margin-bottom: 12px; display: none; }
  .schedule-no-account { font-size: 13px; color: var(--text-3); margin-bottom: 16px; }
  .schedule-no-account a { color: var(--cta); text-decoration: none; font-weight: 600; }
  .schedule-no-account a:hover { text-decoration: underline; }

  .hidden { display: none !important; }

  /* ===== ANIMATIONS ===== */
  @keyframes tgSlideUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .fade-in { animation: fadeIn 0.4s ease; }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 600px) {
    .app-hero { padding: 32px 24px 4px; }
    .platform-grid { grid-template-columns: 1fr; }
    .results-header { flex-direction: column; gap: 12px; align-items: flex-start; }
    .paywall-card { padding: 36px 24px; }
  }
</style>
</head>
<body>
<script src="/nav.js"></script>
<script src="/pro.js"></script>
<script src="/content-cards.js"></script>

<!-- ===== HERO ===== -->
<section class="app-hero">
  <h1>Turn any video into content.</h1>
  <p>Paste a URL, pick your platforms, and generate.</p>
</section>

<!-- ===== INPUT ===== -->
<div class="input-section" id="input-section">
  <div class="url-input-wrap">
    <input type="text" class="url-input" id="url-input" placeholder="Paste a YouTube, TikTok, or Instagram URL..." autocomplete="off" spellcheck="false">
    <button class="paste-btn" id="paste-btn" title="Paste from clipboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
    </button>
  </div>

  <div class="format-label" style="font-size: 12px; font-weight: 500; color: var(--text-4); text-align: center; margin-top: 20px; letter-spacing: 0.04em;">Choose output formats</div>
  <div class="format-picker" id="format-picker" style="margin-top: 8px;">
    <button class="format-pill selected" data-format="twitter"><span class="pill-icon">&#120143;</span> Twitter</button>
    <button class="format-pill selected" data-format="linkedin"><span class="pill-icon">in</span> LinkedIn</button>
    <button class="format-pill" data-format="facebook"><span class="pill-icon">f</span> Facebook</button>
    <button class="format-pill" data-format="instagram"><span class="pill-icon">&#128247;</span> Instagram</button>
    <button class="format-pill" data-format="tiktok"><span class="pill-icon">&#9835;</span> TikTok</button>
    <button class="format-pill" data-format="blog"><span class="pill-icon">&#9997;&#65039;</span> Blog</button>
    <button class="format-pill" data-format="quotes"><span class="pill-icon">&#128172;</span> Quotes</button>
    <button class="format-pill" data-format="transcript"><span class="pill-icon">&#128196;</span> Transcript</button>
  </div>

  <div class="lang-row">
    <span class="lang-label">Output language:</span>
    <select class="lang-select" id="lang-select">
      <option value="English" selected>English</option>
      <option value="Spanish">Spanish</option>
      <option value="Portuguese">Portuguese</option>
      <option value="French">French</option>
      <option value="German">German</option>
      <option value="Italian">Italian</option>
      <option value="Dutch">Dutch</option>
      <option value="Hindi">Hindi</option>
      <option value="Tamil">Tamil</option>
      <option value="Telugu">Telugu</option>
      <option value="Bengali">Bengali</option>
      <option value="Arabic">Arabic</option>
      <option value="Japanese">Japanese</option>
      <option value="Korean">Korean</option>
      <option value="Chinese (Simplified)">Chinese (Simplified)</option>
      <option value="Chinese (Traditional)">Chinese (Traditional)</option>
      <option value="Russian">Russian</option>
      <option value="Turkish">Turkish</option>
      <option value="Indonesian">Indonesian</option>
      <option value="Thai">Thai</option>
      <option value="Vietnamese">Vietnamese</option>
      <option value="Polish">Polish</option>
      <option value="Ukrainian">Ukrainian</option>
      <option value="Swedish">Swedish</option>
    </select>
  </div>

  <button class="generate-btn" id="generate-btn" onclick="handleGenerate()">Generate Content</button>
  <p class="credit-indicator" id="credit-indicator"></p>
  <p class="input-hint" id="input-hint">Paste any video URL</p>
</div>

<!-- ===== ERROR ===== -->
<div class="error-msg hidden" id="error-section">
  <p id="error-text"></p>
</div>

<!-- ===== PROCESSING ===== -->
<div class="processing hidden" id="processing-section">
  <div class="spinner"></div>
  <p id="processing-msg">Fetching transcript...</p>
  <p class="substep" id="processing-sub">This may take a moment</p>
</div>

<!-- ===== RESULTS ===== -->
<div class="results hidden" id="results-section">
  <div class="results-header">
    <h2 id="results-title">Your content is ready</h2>
    <div style="display:flex;align-items:center;gap:12px;">
      <span class="saved-badge hidden" id="saved-badge">Saved to Library <a href="/workspace" id="saved-link">View</a></span>
      <button class="download-all-btn" onclick="downloadAll()">Download All</button>
    </div>
  </div>
  <p style="font-size:12px;color:var(--text-5);margin-bottom:16px;">Content is generated from auto-transcribed audio and may contain errors.</p>
  <div class="platform-grid" id="platform-grid"></div>
  <div class="new-video-row">
    <button class="new-video-btn" onclick="resetApp()">Generate from another video</button>
  </div>
</div>

<script>
(function(){
  'use strict';

  // ==============================
  // FORMAT PICKER
  // ==============================
  document.getElementById('format-picker').addEventListener('click', function(e) {
    var pill = e.target.closest('.format-pill');
    if (!pill) return;
    pill.classList.toggle('selected');
  });

  function getSelectedFormats() {
    var pills = document.querySelectorAll('.format-pill.selected');
    var formats = [];
    pills.forEach(function(p) { formats.push(p.getAttribute('data-format')); });
    return formats;
  }

  // ==============================
  // STATE
  // ==============================
  var currentResult = null;
  var currentTitle = '';
  var currentVideoId = '';
  var currentVideoUrl = '';
  var currentPlatform = '';
  var currentTranscript = '';
  var currentLanguage = 'en';

  // ==============================
  // CREDIT HELPERS
  // ==============================
  function getFreeUsed() {
    try { return localStorage.getItem('tg_free_used') === 'true'; } catch(e) { return false; }
  }
  function setFreeUsed() {
    try { localStorage.setItem('tg_free_used', 'true'); } catch(e) {}
  }
  function getCredits() {
    try { return parseInt(localStorage.getItem('tg_credits') || '0', 10); } catch(e) { return 0; }
  }
  function setCredits(n) {
    try { localStorage.setItem('tg_credits', String(n)); } catch(e) {}
  }
  function canGenerate() {
    if (window.TGPro && TGPro.isPro()) return true;
    if (getCredits() > 0) return true;
    if (!getFreeUsed()) return true;
    // Check server-side credits for signed-in users
    if (window.TGUser && TGUser.isSignedIn()) {
      var u = TGUser.get();
      if (u && u.credits > 0) return true;
    }
    return false;
  }

  // ==============================
  // CREDIT INDICATOR
  // ==============================
  function updateCreditIndicator() {
    var el = document.getElementById('credit-indicator');
    var signedIn = window.TGUser && TGUser.isSignedIn();
    var isPro = window.TGUser && TGUser.isPro();

    if (isPro) {
      var u = TGUser.get();
      var used = u.monthly_usage || 0;
      var limit = u.usage_limit || 200;
      if (used >= limit) {
        el.innerHTML = '<span style="color:var(--error)">Monthly limit reached (' + limit + '/' + limit + ')</span>';
      } else {
        el.textContent = used + ' / ' + limit + ' videos this month';
      }
    } else if (signedIn) {
      var u = TGUser.get();
      var credits = u ? u.credits : 0;
      if (credits > 0) {
        el.textContent = credits + ' credit' + (credits !== 1 ? 's' : '') + ' remaining';
      } else {
        el.textContent = 'No credits remaining';
      }
    } else if (!getFreeUsed()) {
      el.textContent = '1 free generation available';
    } else {
      el.innerHTML = '<a href="/api/auth/google">Sign in for 3 free videos</a>';
    }
  }

  // ==============================
  // PAYWALL
  // ==============================
  function showPaywall() {
    if (window.TGPro) TGPro.showUpgradeModal();
  }
  function hidePaywall() {
    if (window.TGPro) TGPro.hideUpgradeModal();
  }

  function showNoCaptions() {
    if (document.getElementById('nocaptions-overlay')) return;
    var div = document.createElement('div');
    div.className = 'paywall-overlay';
    div.id = 'nocaptions-overlay';
    div.innerHTML =
      '<div class="paywall-card">' +
        '<h2>No captions available</h2>' +
        '<p>This video doesn\u2019t have captions or subtitles enabled, so we can\u2019t extract a transcript.</p>' +
        '<p style="font-size:13px;color:var(--text-4);margin-bottom:24px;">Try a different video, or look for one with auto-generated or manual captions.</p>' +
        '<div class="paywall-btns">' +
          '<button class="paywall-btn primary" onclick="document.getElementById(\'nocaptions-overlay\').remove();resetApp();">Try another video</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(div);
  }

  // ==============================
  // PARSE VIDEO URL (multi-platform)
  // ==============================
  function parseVideoUrl(url) {
    url = url.trim();

    // Bare YouTube ID
    if (/^[a-zA-Z0-9_-]{11}$/.test(url)) {
      return { platform: 'youtube', id: url, url: 'https://www.youtube.com/watch?v=' + url };
    }

    // Ensure URL has protocol
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

    try { var u = new URL(url); } catch(e) { return null; }
    var host = u.hostname.replace(/^www\./, '').replace(/^m\./, '');

    // YouTube
    if (host === 'youtube.com' || host === 'youtu.be') {
      var vid = null;
      if (u.searchParams.get('v')) vid = u.searchParams.get('v');
      else if (host === 'youtu.be') vid = u.pathname.split('/')[1];
      else {
        var m = u.pathname.match(/\/(shorts|embed|v|live)\/([a-zA-Z0-9_-]{11})/);
        if (m) vid = m[2];
      }
      if (vid && /^[a-zA-Z0-9_-]{11}$/.test(vid)) {
        return { platform: 'youtube', id: vid, url: 'https://www.youtube.com/watch?v=' + vid };
      }
      return null;
    }

    // TikTok
    if (host === 'tiktok.com' || host === 'vm.tiktok.com') {
      return { platform: 'tiktok', id: url, url: url };
    }

    // Instagram
    if (host === 'instagram.com') {
      if (/\/(reel|p|tv)\//.test(u.pathname)) {
        return { platform: 'instagram', id: url, url: url };
      }
      return null;
    }

    // Facebook
    if (host === 'facebook.com' || host === 'fb.watch') {
      return { platform: 'facebook', id: url, url: url };
    }

    // X / Twitter
    if (host === 'x.com' || host === 'twitter.com') {
      if (/\/status\/\d+/.test(u.pathname)) {
        return { platform: 'twitter', id: url, url: url };
      }
      return null;
    }

    return null;
  }

  // ==============================
  // GENERATE
  // ==============================
  window.handleGenerate = async function() {
    var url = document.getElementById('url-input').value.trim();
    if (!url) { showError('Please paste a video URL.'); return; }

    var parsed = parseVideoUrl(url);
    if (!parsed) { showError('Could not recognize that URL. Supported: YouTube, TikTok, Instagram, Facebook, X/Twitter.'); return; }

    var formats = getSelectedFormats();
    if (formats.length === 0) { showError('Select at least one format.'); return; }

    // Separate transcript (client-side) from AI formats
    var wantTranscript = formats.indexOf('transcript') !== -1;
    var aiFormats = formats.filter(function(f) { return f !== 'transcript'; });

    // Need credits for AI formats, transcript alone is free
    if (aiFormats.length > 0 && !canGenerate()) { showPaywall(); return; }

    hidePaywall();
    showProcessing('Fetching transcript...');

    try {
      // Step 1: Fetch transcript
      var tRes = await fetch('/api/transcript?url=' + encodeURIComponent(parsed.url), { credentials: 'same-origin' });

      // Handle 202 async — keep polling until ready (up to ~45s)
      var retries = 0;
      while (tRes.status === 202 && retries < 10) {
        retries++;
        updateProcessing('Processing video...', 'This can take a moment for longer videos (' + retries + '/10)');
        await new Promise(function(r) { setTimeout(r, 4000); });
        tRes = await fetch('/api/transcript?url=' + encodeURIComponent(parsed.url), { credentials: 'same-origin' });
      }
      if (tRes.status === 202) {
        hideProcessing();
        showError('This video is taking too long to process. Please try again in a minute.');
        return;
      }

      var tData = await tRes.json();
      if (!tRes.ok || !tData.segments) {
        if (tData.no_captions) {
          hideProcessing();
          showNoCaptions();
          return;
        }
        throw new Error(tData.error || 'Could not fetch transcript for this video.');
      }

      currentTitle = tData.title || 'Video';
      currentVideoId = parsed.platform === 'youtube' ? parsed.id : '';
      currentVideoUrl = parsed.url;
      currentPlatform = parsed.platform;
      currentLanguage = tData.language || 'en';
      var transcriptText = tData.segments.map(function(s) { return s.text; }).join(' ');
      currentTranscript = tData.segments.map(function(s) {
        var mins = Math.floor(s.start / 60);
        var secs = Math.floor(s.start % 60);
        var ts = String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
        return '[' + ts + '] ' + s.text;
      }).join('\n');

      var gData = {};

      // Step 2: Generate AI formats (if any selected)
      if (aiFormats.length > 0) {
        var label = aiFormats.length === 1 ? aiFormats[0] : aiFormats.length + ' formats';
        updateProcessing('Generating ' + label + '...', 'This may take a moment');

        var gRes = await fetch('/api/generate', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'x-free-used': getFreeUsed() ? 'true' : 'false'
          },
          body: JSON.stringify({
            transcript: transcriptText,
            formats: aiFormats,
            videoId: currentVideoId || currentVideoUrl,
            videoTitle: currentTitle,
            platform: currentPlatform,
            videoUrl: currentVideoUrl,
            transcriptLanguage: currentLanguage,
            outputLanguage: document.getElementById('lang-select').value
          })
        });
        gData = await gRes.json();
        if (gRes.status === 402) {
          hideProcessing();
          showPaywall();
          return;
        }
        if (gRes.status === 403) {
          hideProcessing();
          showError(gData.error || 'Monthly limit reached.');
          return;
        }
        if (!gRes.ok) {
          throw new Error(gData.error || 'Content generation failed.');
        }

        // Mark free usage on first anonymous generation
        if (!getFreeUsed()) setFreeUsed();
      }

      if (wantTranscript) {
        gData._transcript = currentTranscript;
      }

      currentResult = gData;
      renderResults(gData, currentTitle, currentVideoId);

      // Refresh credit state after generation
      if (window.TGUser && TGUser.isSignedIn()) {
        TGUser.refresh().then(function() { updateCreditIndicator(); });
      } else {
        updateCreditIndicator();
      }

    } catch(err) {
      hideProcessing();
      showError(err.message);
    }
  };

  // ==============================
  // UI HELPERS
  // ==============================
  function showError(msg) {
    var el = document.getElementById('error-section');
    document.getElementById('error-text').textContent = msg;
    el.classList.remove('hidden');
    setTimeout(function(){ el.classList.add('hidden'); }, 8000);
  }

  function showProcessing(msg) {
    document.getElementById('input-section').classList.add('hidden');
    document.getElementById('results-section').classList.add('hidden');
    document.getElementById('error-section').classList.add('hidden');
    var sec = document.getElementById('processing-section');
    document.getElementById('processing-msg').textContent = msg;
    document.getElementById('processing-sub').textContent = 'This may take a moment';
    sec.classList.remove('hidden');
  }
  function updateProcessing(msg, sub) {
    document.getElementById('processing-msg').textContent = msg;
    if (sub) document.getElementById('processing-sub').textContent = sub;
  }
  function hideProcessing() {
    document.getElementById('processing-section').classList.add('hidden');
    document.getElementById('input-section').classList.remove('hidden');
  }

  // ==============================
  // RENDER RESULTS
  // ==============================
  function renderResults(data, title, videoId) {
    document.getElementById('processing-section').classList.add('hidden');
    document.getElementById('input-section').classList.add('hidden');
    var sec = document.getElementById('results-section');
    sec.classList.remove('hidden');
    sec.classList.add('fade-in');
    document.getElementById('results-title').textContent = title;

    // Show saved badge for signed-in users
    var badge = document.getElementById('saved-badge');
    if (window.TGUser && TGUser.isSignedIn() && (videoId || currentVideoUrl)) {
      document.getElementById('saved-link').href = '/workspace';
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }

    var grid = document.getElementById('platform-grid');
    TGCards.renderCards(data, grid);
  }

  // ==============================
  // DOWNLOAD HELPERS
  // ==============================
  function writeVariations(parts, data, formatter) {
    if (Array.isArray(data)) {
      data.forEach(function(v, i) {
        parts.push('[Variation ' + (i + 1) + ': ' + (v.label || 'Untitled') + ']\n\n');
        parts.push(formatter(v) + '\n\n');
      });
    } else {
      parts.push(formatter(data) + '\n\n');
    }
  }

  // ==============================
  // DOWNLOAD ALL
  // ==============================
  window.downloadAll = function() {
    if (!currentResult) return;
    var parts = [];
    var title = currentTitle || 'Video';
    parts.push('=== ' + title + ' ===\n');
    parts.push('Generated by TranscriptGrab\n\n');

    if (currentResult._transcript) {
      parts.push('--- TRANSCRIPT ---\n\n' + currentResult._transcript + '\n\n');
    }
    if (currentResult.twitter && currentResult.twitter.tweets) {
      parts.push('--- TWITTER THREAD ---\n\n');
      currentResult.twitter.tweets.forEach(function(t, i) {
        parts.push((i+1) + '/ ' + t + '\n\n');
      });
    }
    if (currentResult.linkedin) {
      parts.push('\n--- LINKEDIN ---\n\n');
      writeVariations(parts, currentResult.linkedin, function(v) { return v.content; });
    }
    if (currentResult.facebook) {
      parts.push('\n--- FACEBOOK ---\n\n');
      writeVariations(parts, currentResult.facebook, function(v) { return v.content; });
    }
    if (currentResult.instagram) {
      parts.push('\n--- INSTAGRAM ---\n\n');
      writeVariations(parts, currentResult.instagram, function(v) { return v.content; });
    }
    if (currentResult.tiktok) {
      parts.push('\n--- TIKTOK ---\n\n');
      writeVariations(parts, currentResult.tiktok, function(v) { return 'Caption:\n' + (v.caption||'') + '\n\nScript:\n' + (v.script||''); });
    }
    if (currentResult.blog) {
      parts.push('\n--- BLOG POST ---\n\n');
      writeVariations(parts, currentResult.blog, function(v) { return '# ' + (v.title||'') + '\n\n' + (v.content||''); });
    }
    if (currentResult.quotes) {
      parts.push('\n--- KEY QUOTES ---\n\n');
      currentResult.quotes.forEach(function(q) {
        parts.push('"' + q.text + '"' + (q.timestamp ? ' [' + q.timestamp + ']' : '') + '\n\n');
      });
    }

    var blob = new Blob([parts.join('')], { type: 'text/plain' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = slugify(title) + '-content.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // ==============================
  // RESET
  // ==============================
  window.resetApp = function() {
    currentResult = null;
    currentTitle = '';
    currentVideoId = '';
    currentVideoUrl = '';
    currentPlatform = '';
    currentTranscript = '';
    currentLanguage = 'en';
    document.getElementById('lang-select').value = 'English';
    document.getElementById('results-section').classList.add('hidden');
    document.getElementById('input-section').classList.remove('hidden');
    document.getElementById('url-input').value = '';
    document.getElementById('url-input').focus();
    updateCreditIndicator();
  };

  // ==============================
  // UTILS
  // ==============================
  function slugify(s) {
    return s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').substring(0, 60);
  }

  // ==============================
  // PASTE BUTTON
  // ==============================
  document.getElementById('paste-btn').addEventListener('click', function() {
    var btn = this;
    navigator.clipboard.readText().then(function(text) {
      if (text) {
        document.getElementById('url-input').value = text.trim();
        btn.classList.add('pasted');
        setTimeout(function() { btn.classList.remove('pasted'); }, 1500);
      }
    }).catch(function() {
      // Clipboard permission denied — focus input so user can Ctrl+V
      document.getElementById('url-input').focus();
    });
  });

  // ==============================
  // ENTER KEY
  // ==============================
  document.getElementById('url-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') handleGenerate();
  });

  // ==============================
  // INIT — pre-fill from URL params (regenerate from library)
  // ==============================
  var params = new URLSearchParams(window.location.search);
  if (params.get('url')) {
    document.getElementById('url-input').value = params.get('url');
  } else if (params.get('v')) {
    document.getElementById('url-input').value = 'https://youtube.com/watch?v=' + params.get('v');
  }

  // Show credit indicator once auth state is known
  if (window.TGUser && TGUser.ready) {
    TGUser.ready.then(function() { updateCreditIndicator(); });
  } else {
    updateCreditIndicator();
  }

})();
</script>

<!-- Schedule Module -->
<script>
(function(){
  'use strict';

  var socialConnections = null; // cached after first load

  window.TGSchedule = {
    openModal: function(platform, content) {
      // Pro gate
      if (window.TGPro && !TGPro.isPro()) {
        TGPro.showUpgradeModal();
        return;
      }
      if (!window.TGUser || !TGUser.isSignedIn()) {
        TGPro.showUpgradeModal();
        return;
      }
      showScheduleModal(platform, content);
    }
  };

  async function loadConnections() {
    if (socialConnections !== null) return socialConnections;
    try {
      var res = await fetch('/api/social', { credentials: 'same-origin' });
      if (res.ok) {
        var data = await res.json();
        socialConnections = data.connections || [];
      } else {
        socialConnections = [];
      }
    } catch(e) {
      socialConnections = [];
    }
    return socialConnections;
  }

  async function showScheduleModal(platform, content) {
    var connections = await loadConnections();
    var platformConns = connections.filter(function(c) { return c.platform === platform; });

    var overlay = document.createElement('div');
    overlay.className = 'schedule-overlay';
    overlay.id = 'schedule-overlay';

    var platformName = platform === 'twitter' ? 'X / Twitter' : 'Facebook';

    // Default datetime: 1 hour from now
    var defaultTime = new Date(Date.now() + 3600000);
    var dtStr = defaultTime.getFullYear() + '-' +
      String(defaultTime.getMonth() + 1).padStart(2, '0') + '-' +
      String(defaultTime.getDate()).padStart(2, '0') + 'T' +
      String(defaultTime.getHours()).padStart(2, '0') + ':' +
      String(defaultTime.getMinutes()).padStart(2, '0');

    var accountHtml = '';
    if (platformConns.length === 0) {
      accountHtml =
        '<div class="schedule-no-account">No ' + platformName + ' account connected. ' +
        '<a href="/workspace?tab=social">Connect one first</a></div>';
    } else {
      accountHtml =
        '<label class="schedule-label">Account</label>' +
        '<select class="schedule-select" id="schedule-account">';
      platformConns.forEach(function(c) {
        accountHtml += '<option value="' + c.id + '">' + escapeHtml(c.platform_username || platformName) + '</option>';
      });
      accountHtml += '</select>';
    }

    overlay.innerHTML =
      '<div class="schedule-card">' +
        '<h3>Schedule to ' + platformName + '</h3>' +
        '<p class="schedule-subtitle">Pick a time and review the content before scheduling.</p>' +
        accountHtml +
        '<label class="schedule-label">When</label>' +
        '<input type="datetime-local" class="schedule-datetime" id="schedule-datetime" value="' + dtStr + '">' +
        '<label class="schedule-label">Content</label>' +
        '<textarea class="schedule-textarea" id="schedule-content">' + escapeHtml(content || '') + '</textarea>' +
        '<div class="schedule-error" id="schedule-error"></div>' +
        '<div class="schedule-btns">' +
          '<button class="schedule-btn cancel" onclick="document.getElementById(\'schedule-overlay\').remove()">Cancel</button>' +
          '<button class="schedule-btn submit" id="schedule-submit-btn"' + (platformConns.length === 0 ? ' disabled' : '') + '>Schedule Post</button>' +
        '</div>' +
      '</div>';

    document.body.appendChild(overlay);

    // Close on backdrop click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) overlay.remove();
    });

    // Submit handler
    var submitBtn = document.getElementById('schedule-submit-btn');
    if (submitBtn && platformConns.length > 0) {
      submitBtn.addEventListener('click', async function() {
        var errorEl = document.getElementById('schedule-error');
        errorEl.style.display = 'none';

        var accountId = parseInt(document.getElementById('schedule-account').value, 10);
        var dateVal = document.getElementById('schedule-datetime').value;
        var contentVal = document.getElementById('schedule-content').value.trim();

        if (!dateVal) {
          errorEl.textContent = 'Pick a date and time.';
          errorEl.style.display = 'block';
          return;
        }
        if (!contentVal) {
          errorEl.textContent = 'Content cannot be empty.';
          errorEl.style.display = 'block';
          return;
        }

        var scheduledAt = new Date(dateVal);
        if (scheduledAt <= new Date()) {
          errorEl.textContent = 'Scheduled time must be in the future.';
          errorEl.style.display = 'block';
          return;
        }

        submitBtn.textContent = 'Scheduling...';
        submitBtn.disabled = true;

        try {
          // We need the generation ID — look it up from the current state
          var genId = await getGenerationId();
          if (!genId) {
            errorEl.textContent = 'Could not find generation. Try regenerating.';
            errorEl.style.display = 'block';
            submitBtn.textContent = 'Schedule Post';
            submitBtn.disabled = false;
            return;
          }

          var res = await fetch('/api/schedule', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              generationId: genId,
              platform: platform,
              socialConnectionId: accountId,
              scheduledAt: scheduledAt.toISOString(),
              content: contentVal,
            }),
          });

          if (!res.ok) {
            var d = await res.json().catch(function() { return {}; });
            throw new Error(d.error || 'Scheduling failed');
          }

          overlay.remove();
          showScheduleToast('Post scheduled!');
        } catch(e) {
          errorEl.textContent = e.message;
          errorEl.style.display = 'block';
          submitBtn.textContent = 'Schedule Post';
          submitBtn.disabled = false;
        }
      });
    }
  }

  // Get current generation ID by querying the library
  async function getGenerationId() {
    // Try to find the generation for the current video
    try {
      var res = await fetch('/api/library', { credentials: 'same-origin' });
      if (!res.ok) return null;
      var data = await res.json();
      if (!data.videos || data.videos.length === 0) return null;
      // Return the most recent generation ID
      return data.videos[0].id;
    } catch(e) {
      return null;
    }
  }

  function escapeHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function showScheduleToast(msg) {
    if (window.TGPro) {
      TGPro._showToast(msg);
    }
  }
})();
</script>
<script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
